<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Permissions-Policy" content="geolocation=*" />
    <title>åœ°é»ç¸½è¦½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100svh;
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        background-color: #000;
        overflow: hidden;
      }

      #map {
        height: 100svh;
        width: 100svw;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
      }

      /* æ§åˆ¶é¢æ¿æ¨£å¼ */
      .location-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        display: flex;
        gap: 8px;
      }

      .bottom-tabs-panel {
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(0.1px);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .control-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .control-buttons {
        flex: 1;
        overflow-x: auto;
        display: flex;
        gap: 8px;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
      }

      .control-buttons::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
      }

      /* å´é‚Šè³‡è¨Šé¢æ¿ */
      .info-sidebar {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 320px;
        max-height: calc(100svh - 120px);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow-y: auto;
        transform: translateX(110vw);
        transition: transform 0.3s ease;
      }

      .info-sidebar.show {
        transform: translateX(0);
      }

      /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .location-panel {
          top: 10px;
          left: 10px;
        }

        .bottom-tabs-panel {
          bottom: 10px;
          left: 10px;
          right: 10px;
          padding: 12px;
        }

        .control-buttons {
          gap: 6px;
        }

        .info-sidebar {
          top: 10px;
          left: 10px;
          right: 10px;
          width: auto;
          max-height: calc(100svh - 110px);
        }

        .map-control-btn {
          font-size: 12px;
          padding: 6px 10px;
          margin: 0;
          white-space: nowrap;
          flex-shrink: 0;
        }

        .location-btn {
          width: 36px;
          height: 36px;
        }
      }

      .btn {
        font-weight: bold;
        padding: 10px 16px;
        border-radius: 8px;
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 14px;
        border: none;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .btn-primary {
        background-color: #3b82f6;
        color: white;
      }

      .btn-primary:hover {
        background-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #4b5563;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      /* è¿”å›æŒ‰éˆ•æ¨£å¼ */
      .go-back-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #4b5563;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .go-back-btn:hover {
        background-color: #374151;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* å®šä½æŒ‰éˆ•æ¨£å¼ */
      .location-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #9ca3af;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .location-btn:hover {
        background-color: #6b7280;
        transform: translateY(-2px);
      }

      .location-btn.has-location {
        background-color: #3b82f6;
      }

      .location-btn.has-location:hover {
        background-color: #2563eb;
      }

      /* ä½ç½®è¿½è¹¤ç‹€æ…‹æ¨£å¼ */
      .location-btn.tracking {
        background-color: #10b981;
        animation: tracking-pulse 2s infinite;
      }

      .location-btn.tracking:hover {
        background-color: #059669;
      }

      @keyframes tracking-pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
        }
      }

      /* äººåŠ›è«‹æ±‚æŒ‰éˆ•ç‰¹æ®Šæ¨£å¼ */
      #requestHelpBtn {
        background-color: #ef4444;
        color: white;
      }

      #requestHelpBtn:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
      }

      /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        .top-control-panel {
          top: 10px;
          left: 10px;
          right: 10px;
          padding: 8px 12px;
        }

        .bottom-tabs-panel {
          bottom: 10px;
          left: 10px;
          right: 10px;
          padding: 12px;
        }

        .control-buttons {
          gap: 6px;
        }

        .map-control-btn {
          padding: 6px 10px;
          font-size: 12px;
        }
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
      }

      .status-available {
        background-color: #10b981;
      }
      .status-full {
        background-color: #ef4444;
      }
      .status-unknown {
        background-color: #f59e0b;
      }

      /* åœ°åœ–æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
      .map-control-btn {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 12px;
        margin: 0;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        white-space: nowrap;
        flex-shrink: 0;
      }

      .map-control-btn:hover {
        background-color: #f3f4f6;
        border-color: #3b82f6;
      }

      .map-control-btn.active {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 14px;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 0.5rem;
        border: 2px solid rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
      }

      /* åˆ‡æ›æŒ‰éˆ• */
      .toggle-info-btn {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        z-index: 1001;
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      .toggle-info-btn:hover {
        background: white;
        transform: translateY(-50%) scale(1.1);
      }

      @media (max-width: 768px) {
        .toggle-info-btn {
          bottom: 20px;
          top: auto;
          right: 20px;
          transform: none;
        }

        .toggle-info-btn:hover {
          transform: scale(1.1);
        }
      }

      /* Details æ”¶åˆç®­é ­å‹•ç•« */
      details .details-arrow {
        transform: rotate(180deg);
        transition: transform 0.2s ease;
      }

      details:not([open]) .details-arrow {
        transform: rotate(0deg);
      }

      /* è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†æ¨£å¼ */
      #customConfirmModal {
        backdrop-filter: blur(4px);
      }

      #customConfirmModal .bg-white {
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      #customConfirmModal.hidden .bg-white {
        animation: modalSlideOut 0.2s ease-in;
      }

      @keyframes modalSlideOut {
        from {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
        to {
          opacity: 0;
          transform: scale(0.95) translateY(-20px);
        }
      }
    </style>
  </head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VHR24V48H3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'G-VHR24V48H3');
  </script>

  <body class="antialiased text-gray-800">
    <!-- åœ°åœ–å®¹å™¨ -->
    <div id="map"></div>

    <!-- å®šä½æŒ‰éˆ•é¢æ¿ -->
    <div class="location-panel">
      <button id="goBackBtn" class="go-back-btn" title="è¿”å›">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          />
        </svg>
      </button>
      <button id="locateUserBtn" class="location-btn" title="å®šä½">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
      </button>
      <button id="requestHelpBtn" class="location-btn ml-2 hidden" title="è«‹æ±‚äººåŠ›æ”¯æ´">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
          />
        </svg>
      </button>
    </div>

    <!-- åº•éƒ¨åˆ†é é¢æ¿ -->
    <div class="bottom-tabs-panel">
      <div class="control-buttons">
        <button id="showAllBtn" class="map-control-btn active">å…¨éƒ¨</button>
        <button id="showWaterStationBtn" class="map-control-btn">åŠ æ°´ç«™</button>
        <button id="showRestroomBtn" class="map-control-btn">å»æ‰€</button>
        <button id="showShowerStationBtn" class="map-control-btn">æ´—æ¾¡é»</button>
        <button id="showMedicalStationBtn" class="map-control-btn">é†«ç™‚ç«™</button>
        <button id="showAccommodationBtn" class="map-control-btn">ä½å®¿</button>
        <button id="showShuttleBtn" class="map-control-btn hidden">äº¤é€š</button>
        <button id="showDisasterAreaBtn" class="map-control-btn hidden">ç½å€</button>
      </div>
      <button id="toggleInfoBtn" class="btn btn-primary text-sm">æ›´å¤š</button>
    </div>

    <!-- è³‡è¨Šå´é‚Šæ¬„ -->
    <div class="info-sidebar" id="infoSidebar">
      <!-- åœ–ä¾‹èªªæ˜ -->
      <div class="mb-6">
        <h3 class="text-lg font-bold mb-3">åœ–ä¾‹èªªæ˜</h3>
        <div class="space-y-2">
          <div class="legend-item">
            <div class="legend-color" style="background-color: #3b82f6"></div>
            <span>å…‰å¾©ç«è»Šç«™</span>
          </div>
          <div class="legend-item">
            <div
              style="
                background-color: #10b981;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                margin-right: 0.5rem;
              "
            >
              ğŸ 
            </div>
            <span>ä½å®¿é»</span>
          </div>
          <div class="legend-item">
            <div
              style="
                background-color: #06b6d4;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                margin-right: 0.5rem;
              "
            >
              ğŸ’§
            </div>
            <span>åŠ æ°´ç«™</span>
          </div>
          <div class="legend-item">
            <div
              style="
                background-color: #8b5cf6;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                margin-right: 0.5rem;
              "
            >
              ğŸš»
            </div>
            <span>å»æ‰€</span>
          </div>
          <div class="legend-item">
            <div
              style="
                background-color: #f59e0b;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                margin-right: 0.5rem;
              "
            >
              ğŸš¿
            </div>
            <span>æ´—æ¾¡é»</span>
          </div>
          <div class="legend-item">
            <div
              style="
                background-color: #ef4444;
                color: white;
                border-radius: 50%;
                width: 16px;
                height: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                margin-right: 0.5rem;
              "
            >
              ğŸ¥
            </div>
            <span>é†«ç™‚ç«™</span>
          </div>
          <!-- <div class="legend-item">
            <div class="legend-color" style="background-color: #8b5cf6;"></div>
            <span>æ¥é§è·¯ç·š</span>
          </div> -->
          <div class="legend-item">
            <div class="legend-color" style="background-color: #ec4899; opacity: 0.3"></div>
            <span>æ•‘ç½å€åŸŸç¯„åœ</span>
          </div>
        </div>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div class="mb-6">
        <h3 class="text-lg font-bold mb-3">çµ±è¨ˆè³‡è¨Š</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>ç¸½ä½å®¿é»ï¼š</span>
            <span class="font-semibold" id="totalAccommodations">0</span>
          </div>
          <div class="flex justify-between">
            <span>ç¸½åŠ æ°´ç«™ï¼š</span>
            <span class="font-semibold" id="totalWaterStations">0</span>
          </div>
          <div class="flex justify-between">
            <span>ç¸½å»æ‰€ï¼š</span>
            <span class="font-semibold" id="totalRestrooms">0</span>
          </div>
          <div class="flex justify-between">
            <span>ç¸½æ´—æ¾¡é»ï¼š</span>
            <span class="font-semibold" id="totalShowerStations">0</span>
          </div>
          <div class="flex justify-between">
            <span>ç¸½é†«ç™‚ç«™ï¼š</span>
            <span class="font-semibold" id="totalMedicalStations">0</span>
          </div>
          <!-- <div class="flex justify-between">
            <span>ç¸½æ¥é§è·¯ç·šï¼š</span>
            <span class="font-semibold" id="totalShuttleRoutes">0</span>
          </div> -->
        </div>
      </div>

      <!-- å‹•æ…‹åˆ—è¡¨å®¹å™¨ -->
      <div id="dynamicListContainer">
        <!-- ä½å®¿é»åˆ—è¡¨ -->
        <div id="accommodationSection" style="display: none">
          <h3 class="text-lg font-bold mb-3">ä½å®¿é»åˆ—è¡¨</h3>
          <div id="accommodationList" class="space-y-3">
            <!-- ä½å®¿é»åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- åŠ æ°´ç«™åˆ—è¡¨ -->
        <div id="waterStationSection" style="display: none">
          <h3 class="text-lg font-bold mb-3">åŠ æ°´ç«™åˆ—è¡¨</h3>
          <div id="waterStationList" class="space-y-3">
            <!-- åŠ æ°´ç«™åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å»æ‰€åˆ—è¡¨ -->
        <div id="restroomSection" style="display: none">
          <h3 class="text-lg font-bold mb-3">å»æ‰€åˆ—è¡¨</h3>
          <div id="restroomList" class="space-y-3">
            <!-- å»æ‰€åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- æ´—æ¾¡é»åˆ—è¡¨ -->
        <div id="showerStationSection" style="display: none">
          <h3 class="text-lg font-bold mb-3">æ´—æ¾¡é»åˆ—è¡¨</h3>
          <div id="showerStationList" class="space-y-3">
            <!-- æ´—æ¾¡é»åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- é†«ç™‚ç«™åˆ—è¡¨ -->
        <div id="medicalStationSection" style="display: none">
          <h3 class="text-lg font-bold mb-3">é†«ç™‚ç«™åˆ—è¡¨</h3>
          <div id="medicalStationList" class="space-y-3">
            <!-- é†«ç™‚ç«™åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å…¨éƒ¨è¦–åœ–åˆ—è¡¨ -->
        <div id="allSections" style="display: block">
          <h3 class="text-lg font-bold mb-3">æ‰€æœ‰è¨­æ–½</h3>
          <div class="space-y-4">
            <!-- ä½å®¿é» -->
            <details class="border rounded-lg" open>
              <summary
                class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden"
              >
                <span class="font-semibold text-gray-700 flex items-center">
                  <span class="text-orange-600 mr-2">ğŸ </span>
                  ä½å®¿é»
                  <span id="allAccommodationCount" class="ml-2 text-sm text-gray-500">(0)</span>
                </span>
                <svg
                  class="w-5 h-5 transform transition-transform details-arrow"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </summary>
              <div id="allAccommodationContent">
                <!-- ä½å®¿é»å®Œæ•´åˆ—è¡¨ -->
              </div>
            </details>

            <!-- åŠ æ°´ç«™ -->
            <details class="border rounded-lg" open>
              <summary
                class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden"
              >
                <span class="font-semibold text-gray-700 flex items-center">
                  <span class="text-blue-600 mr-2">ğŸ’§</span>
                  åŠ æ°´ç«™
                  <span id="allWaterStationCount" class="ml-2 text-sm text-gray-500">(0)</span>
                </span>
                <svg
                  class="w-5 h-5 transform transition-transform details-arrow"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </summary>
              <div id="allWaterStationContent">
                <!-- åŠ æ°´ç«™å®Œæ•´åˆ—è¡¨ -->
              </div>
            </details>

            <!-- å»æ‰€ -->
            <details class="border rounded-lg" open>
              <summary
                class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden"
              >
                <span class="font-semibold text-gray-700 flex items-center">
                  <span class="text-green-600 mr-2">ğŸš»</span>
                  å»æ‰€
                  <span id="allRestroomCount" class="ml-2 text-sm text-gray-500">(0)</span>
                </span>
                <svg
                  class="w-5 h-5 transform transition-transform details-arrow"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </summary>
              <div id="allRestroomContent">
                <!-- å»æ‰€å®Œæ•´åˆ—è¡¨ -->
              </div>
            </details>

            <!-- æ´—æ¾¡é» -->
            <details class="border rounded-lg" open>
              <summary
                class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden"
              >
                <span class="font-semibold text-gray-700 flex items-center">
                  <span class="text-yellow-600 mr-2">ğŸš¿</span>
                  æ´—æ¾¡é»
                  <span id="allShowerStationCount" class="ml-2 text-sm text-gray-500">(0)</span>
                </span>
                <svg
                  class="w-5 h-5 transform transition-transform details-arrow"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </summary>
              <div id="allShowerStationContent">
                <!-- æ´—æ¾¡é»å®Œæ•´åˆ—è¡¨ -->
              </div>
            </details>

            <!-- é†«ç™‚ç«™ -->
            <details class="border rounded-lg" open>
              <summary
                class="p-3 bg-gray-50 cursor-pointer hover:bg-gray-100 flex items-center justify-between list-none [&::-webkit-details-marker]:hidden"
              >
                <span class="font-semibold text-gray-700 flex items-center">
                  <span class="text-red-600 mr-2">ğŸ¥</span>
                  é†«ç™‚ç«™
                  <span id="allMedicalStationCount" class="ml-2 text-sm text-gray-500">(0)</span>
                </span>
                <svg
                  class="w-5 h-5 transform transition-transform details-arrow"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </summary>
              <div id="allMedicalStationContent">
                <!-- é†«ç™‚ç«™å®Œæ•´åˆ—è¡¨ -->
              </div>
            </details>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-5 left-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 z-50"
    >
      <p id="toastMessage"></p>
    </div>

    <!-- äººåŠ›è«‹æ±‚ Dialog -->
    <div
      id="helpRequestModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">è«‹æ±‚äººåŠ›æ”¯æ´</h3>
          <button id="closeHelpRequestBtn" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <form id="helpRequestForm" class="space-y-4">
          <div>
            <label for="requestType" class="block text-sm font-medium text-gray-700 mb-1"
              >è«‹æ±‚é¡å‹</label
            >
            <select
              id="requestType"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            >
              <option value="">è«‹é¸æ“‡è«‹æ±‚é¡å‹</option>
              <option value="rescue">æ•‘æ´äººåŠ›</option>
              <option value="medical">é†«ç™‚äººåŠ›</option>
              <!-- <option value="logistics">ç‰©è³‡é‹é€</option> -->
              <option value="cleanup">æ¸…ç†äººåŠ›</option>
              <!-- <option value="transport">äº¤é€šå”åŠ©</option> -->
              <option value="other">å…¶ä»–</option>
            </select>
          </div>

          <!-- <div>
            <label for="urgencyLevel" class="block text-sm font-medium text-gray-700 mb-1">ç·Šæ€¥ç¨‹åº¦</label>
            <select id="urgencyLevel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">è«‹é¸æ“‡ç·Šæ€¥ç¨‹åº¦</option>
              <option value="critical">ç·Šæ€¥ (ç«‹å³éœ€è¦)</option>
              <option value="high">é«˜ (24å°æ™‚å…§)</option>
              <option value="medium">ä¸­ (48å°æ™‚å…§)</option>
              <option value="low">ä½ (ä¸€é€±å…§)</option>
            </select>
          </div> -->

          <div>
            <label for="peopleNeeded" class="block text-sm font-medium text-gray-700 mb-1"
              >æ‰€éœ€äººæ•¸</label
            >
            <input
              type="number"
              id="peopleNeeded"
              min="1"
              max="100"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label for="contactPerson" class="block text-sm font-medium text-gray-700 mb-1"
              >è¯çµ¡äºº</label
            >
            <input
              type="text"
              id="contactPerson"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1"
              >è¯çµ¡é›»è©±</label
            >
            <input
              type="tel"
              id="contactPhone"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>

          <div>
            <label for="location" class="block text-sm font-medium text-gray-700 mb-1"
              >è©³ç´°åœ°é»</label
            >
            <input
              type="text"
              id="location"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="å°‡è‡ªå‹•å¡«å…¥ç•¶å‰ä½ç½®"
              readonly
            />
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-1"
              >è©³ç´°æè¿°</label
            >
            <textarea
              id="description"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="è«‹è©³ç´°æè¿°éœ€è¦çš„å”åŠ©å…§å®¹..."
              required
            ></textarea>
          </div>

          <div class="flex space-x-3 pt-4">
            <button
              type="button"
              id="cancelHelpRequestBtn"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
            >
              å–æ¶ˆ
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors"
            >
              æäº¤è«‹æ±‚
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- è‡ªå®šç¾©ç¢ºèªå°è©±æ¡† -->
    <div
      id="customConfirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
        <div class="mb-4">
          <h3 id="confirmTitle" class="text-lg font-bold text-gray-800 mb-2">ç¢ºèª</h3>
          <p id="confirmMessage" class="text-gray-600"></p>
        </div>

        <div class="flex space-x-3 pt-4">
          <button
            id="confirmCancelBtn"
            class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button
            id="confirmOkBtn"
            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
          >
            ç¢ºå®š
          </button>
        </div>
      </div>
    </div>

    <!-- å›å ±å•é¡Œå°è©±æ¡† -->
    <div
      id="reportIssueModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">å›å ±å•é¡Œ</h3>
          <button
            id="closeReportIssueBtn"
            class="text-gray-400 hover:text-gray-600 transition-colors"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
        </div>

        <form id="reportIssueForm" class="space-y-4">
          <div>
            <label for="issueCategory" class="block text-sm font-medium text-gray-700 mb-1"
              >å•é¡Œé»é¡å‹</label
            >
            <input
              type="text"
              id="issueCategory"
              name="category"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
              readonly
            />
          </div>

          <div>
            <label for="issueName" class="block text-sm font-medium text-gray-700 mb-1"
              >å•é¡Œé»åç¨±</label
            >
            <input
              type="text"
              id="issueName"
              name="name"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100"
              readonly
            />
          </div>

          <div>
            <label for="issueReason" class="block text-sm font-medium text-gray-700 mb-1"
              >å•é¡ŒåŸå›  <span class="text-red-500">*</span></label
            >
            <textarea
              id="issueReason"
              name="reason"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="è«‹æè¿°æ‚¨ç™¼ç¾çš„å•é¡Œ..."
              required
            ></textarea>
          </div>

          <input type="hidden" id="issueId" name="id" />

          <div class="flex space-x-3 pt-4">
            <button
              type="button"
              id="cancelReportIssueBtn"
              class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors"
            >
              å–æ¶ˆ
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
            >
              æäº¤å›å ±
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      // DOM Elements
      const itemModal = document.getElementById('itemModal');
      const openModalBtn = document.getElementById('openModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const itemForm = document.getElementById('itemForm');
      const itemsContainer = document.getElementById('itemsContainer');
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const filterContainer = document.getElementById('filterContainer');
      const exportDataBtn = document.getElementById('exportDataBtn');

      let pinnedItems = [];
      let unpinnedItems = [];
      let currentFilter = 'all';

      const API_URL = 'https://guangfu250923.pttapp.cc';

      // é€šç”¨åˆ†é æ•¸æ“šç²å–å‡½æ•¸
      const fetchAllPaginatedData = async (endpoint) => {
        try {
          let allData = [];
          let nextUrl = `${API_URL}${endpoint}`;

          while (nextUrl) {
            const response = await fetch(nextUrl, {
              method: 'GET',
              headers: {
                'Content-Type': 'application/json',
              },
            });
            const data = await response.json();

            // å°‡ç•¶å‰é é¢çš„æ•¸æ“šåŠ å…¥ç¸½æ•¸æ“šä¸­
            if (data.member && Array.isArray(data.member)) {
              allData = allData.concat(data.member);
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é 
            if (data.next) {
              nextUrl = `${API_URL}${data.next}`;
            } else {
              nextUrl = null;
            }
          }

          return {
            member: allData,
            total: allData.length,
          };
        } catch (error) {
          console.error(`Error fetching data from ${endpoint}:`, error);
          throw error;
        }
      };

      // è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†å‡½æ•¸
      function customConfirm(message, title = 'ç¢ºèª') {
        return new Promise((resolve) => {
          const modal = document.getElementById('customConfirmModal');
          const titleElement = document.getElementById('confirmTitle');
          const messageElement = document.getElementById('confirmMessage');
          const okBtn = document.getElementById('confirmOkBtn');
          const cancelBtn = document.getElementById('confirmCancelBtn');

          titleElement.textContent = title;
          // è™•ç†æ›è¡Œç¬¦ï¼Œå°‡ \r\nã€\nã€\r è½‰æ›ç‚º <br> æ¨™ç±¤
          const formattedMessage = message
            .replace(/\r\n/g, '<br>')
            .replace(/\n/g, '<br>')
            .replace(/\r/g, '<br>');
          messageElement.innerHTML = formattedMessage;

          // é¡¯ç¤ºå°è©±æ¡†
          modal.classList.remove('hidden');

          // è™•ç†ç¢ºå®šæŒ‰éˆ•
          const handleOk = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleKeyDown);
            // ç­‰å¾…å‹•ç•«å®Œæˆå¾Œè§£æPromise
            setTimeout(() => resolve(true), 200);
          };

          // è™•ç†å–æ¶ˆæŒ‰éˆ•
          const handleCancel = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', handleOk);
            cancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleKeyDown);
            // ç­‰å¾…å‹•ç•«å®Œæˆå¾Œè§£æPromise
            setTimeout(() => resolve(false), 200);
          };

          okBtn.addEventListener('click', handleOk);
          cancelBtn.addEventListener('click', handleCancel);

          // ESCéµå–æ¶ˆ
          const handleKeyDown = (event) => {
            if (event.key === 'Escape') {
              handleCancel();
            }
          };
          document.addEventListener('keydown', handleKeyDown);

          // é»æ“ŠèƒŒæ™¯é—œé–‰
          modal.addEventListener('click', (event) => {
            if (event.target === modal) {
              handleCancel();
            }
          });
        });
      }

      const getAccommodationList = async () => {
        try {
          return await fetchAllPaginatedData('/accommodations');
        } catch (error) {
          console.error('Error fetching accommodation data:', error);
          showToast('ç²å–ä½å®¿è³‡æ–™å¤±æ•—', 'error');
          return [];
        }
      };

      const getWaterRefillStationList = async () => {
        try {
          return await fetchAllPaginatedData('/water_refill_stations');
        } catch (error) {
          console.error('Error fetching water refill station data:', error);
          showToast('ç²å–åŠ æ°´ç«™è³‡æ–™å¤±æ•—', 'error');
          return [];
        }
      };

      const getRestroomsList = async () => {
        try {
          return await fetchAllPaginatedData('/restrooms');
        } catch (error) {
          console.error('Error fetching restroom data:', error);
          showToast('ç²å–å»æ‰€è³‡æ–™å¤±æ•—', 'error');
          return [];
        }
      };

      const getMedicalStationList = async () => {
        try {
          return await fetchAllPaginatedData('/medical_stations');
        } catch (error) {
          console.error('Error fetching medical station data:', error);
          showToast('ç²å–é†«ç™‚ç«™è³‡æ–™å¤±æ•—', 'error');
          return [];
        }
      };

      const getShowerStationList = async () => {
        try {
          return await fetchAllPaginatedData('/shower_stations');
        } catch (error) {
          console.error('Error fetching shower station data:', error);
          showToast('ç²å–æ´—æ¾¡é»è³‡æ–™å¤±æ•—', 'error');
          return [];
        }
      };

      // å…‰å¾©ç«è»Šç«™åº§æ¨™
      const guangfuStation = {
        lat: 23.66666199167715,
        lng: 121.42127202771245,
        name: 'å…‰å¾©ç«è»Šç«™',
      };

      // æ¥é§è·¯ç·šåº§æ¨™é»
      const shuttleRoutes = [
        //     {
        //     "å¡«è¡¨äºº": "",
        //     "å‡ºç™¼æ™‚é–“": "æ¯æ—¥ä¸Šåˆ7:00è‡³10:00ã€ä¸‹åˆ16:00è‡³20:00 - æ¯å°æ™‚ç™¼è»Š",
        //     "å‡ºç™¼åœ°é»": "æ–°åŸã€èŠ±è“®ã€å‰å®‰ã€å£½è±ã€ç‰é‡Œ",
        //     "ç›®çš„åœ°": "å…‰å¾©",
        //     "route": [
        //         [24.12786103472596, 121.64084427078892],
        //         [23.993051286661405, 121.60158677432389],
        //         [23.968242211828, 121.58264853896807],
        //         [23.869280085605453, 121.51091808661023],
        //         [23.666473553075193, 121.42121838314402],
        //         [23.331815524367528, 121.31176291197325],
        //     ],
        //     "è²»ç”¨": 0,
        //     "è¯çµ¡äºº": {text:"", url: ""},
        //     "å‚™è¨»": "å¿—å·¥å…è²»å¤§å®¢è»Šæ¥é§æœå‹™ğŸšŒ\r\nğŸ“æœå‹™åœ°é»ï¼šæ–°åŸã€èŠ±è“®ã€å‰å®‰ã€å£½è±åŠç‰é‡Œç«™ï¼Œæ¯æ—¥æä¾› #6è¼›å¤§å®¢è»Š #6æ¢æœå‹™è·¯ç·šï¼Œ\r\nğŸ“æœå‹™æ™‚æ®µï¼šï¼Œä¸Šåˆ7:00è‡³10:00ã€ä¸‹åˆ16:00è‡³20:00ï¼Œæ¯å°æ™‚ç™¼è»Š\r\nğŸ“å„ç«è»Šç«™é»åŠæ¥é§å¤§å®¢è»Šçš†å¼µè²¼è­˜åˆ¥åœ–å¡ä¾›æ°‘çœ¾è­˜åˆ¥ï¼Œå¦‚æœ‰äº¤é€šæ¥é§éœ€æ±‚ä¹‹å¿—å·¥å¯æ­ä¹˜ä½¿ç”¨ã€‚"
        //   },
        //   {
        //     "å¡«è¡¨äºº": "å°è·¯",
        //     "å‡ºç™¼æ™‚é–“": "9/30 04:00å‡ºç™¼, 16:00å›",
        //     "å‡ºç™¼åœ°é»": "æ¡ƒåœ’",
        //     "ç›®çš„åœ°": "å…‰å¾©",
        //     "route": [
        //         [24.98914852563466, 121.31451510205873],
        //         [23.666473553075193, 121.42121838314402]
        //     ],
        //     "è²»ç”¨": 0,
        //     "è¯çµ¡äºº": {text:"hikarurururu", url: "https://www.threads.com/@hikarurururu"},
        //     "å‚™è¨»": ""
        //   },
        //   {
        //     "å¡«è¡¨äºº": "å°è·¯",
        //     "å‡ºç™¼æ™‚é–“": "10/1 04:15å‡ºç™¼, 18:00~19:00å›",
        //     "å‡ºç™¼åœ°é»": "æ¿æ©‹è»Šç«™",
        //     "ç›®çš„åœ°": "å…‰å¾©",
        //     "route": [
        //         [25.01427393578768, 121.46355785779636],
        //         [23.666473553075193, 121.42121838314402]
        //     ],
        //     "è²»ç”¨": 0,
        //     "è¯çµ¡äºº": {text:"yenpeiju  Threads", url: "https://www.threads.com/@yenpeiju/post/DPJGf8oEiZ3?xmt=AQF0O4QTEvKnYCEd7CHVTpbqhT7818t2ofoqygeTn_NwIg"},
        //     "å‚™è¨»": ""
        //   },
        //   {
        //     "å¡«è¡¨äºº": "å°è·¯",
        //     "å‡ºç™¼æ™‚é–“": "9/30 00:00å‡ºç™¼, 10/1å›",
        //     "å‡ºç™¼åœ°é»": "å°ä¸­å¸‚ äº”æ¬Šè»Šç«™",
        //     "ç›®çš„åœ°": "å…‰å¾©",
        //     "route": [
        //         [24.128934015810774, 120.66660694082738],
        //         [23.666473553075193, 121.42121838314402]
        //     ],
        //     "è²»ç”¨": 0,
        //     "è¯çµ¡äºº": {text:"molly1217lin", url: "https://www.threads.com/@molly1217lin"},
        //     "å‚™è¨»": ""
        // }
      ];

      // æ•‘ç½å€åŸŸé‚Šç•Œ
      const disasterArea = [
        [23.728, 121.33], // é¦¬å¤ªéæºªä¸Šæ¸¸
        [23.71, 121.36], // ä¸­æ®µ
        [23.688, 121.41], // å…‰å¾©é„‰æ ¸å¿ƒç½å€
        [23.67, 121.45], // ä¸‹æ¸¸é‚Šç•Œ
        [23.63, 121.42], // å—å´æ‘é‡Œ
        [23.64, 121.39], // è¥¿å´é‚Šç·£
        [23.728, 121.33], // å›åˆ°èµ·é»
      ];

      // åœ°åœ–è®Šæ•¸
      let map;
      let accommodationMarkers = [];
      let waterStationMarkers = [];
      let restroomMarkers = [];
      let showerStationMarkers = [];
      let medicalStationMarkers = [];
      let shuttlePolylines = [];

      // å…¨å±€æ•¸æ“šå­˜å„²
      let currentAccommodationData = [];
      let currentWaterStationData = [];
      let currentRestroomData = [];
      let currentShowerStationData = [];
      let currentMedicalStationData = [];
      let disasterPolygon;
      let userLocationMarker = null;
      let isLocationVisible = false;
      let hasLocationPermission = false;
      let userPosition = null;
      let watchId = null; // ä½ç½®è¿½è¹¤ID
      let isWatchingPosition = false; // æ˜¯å¦æ­£åœ¨è¿½è¹¤ä½ç½®

      // è¼‰å…¥ä¸¦åˆå§‹åŒ–åœ°åœ–è³‡æ–™
      async function loadMapData() {
        console.log('=== é–‹å§‹è¼‰å…¥åœ°åœ–è³‡æ–™ ===');
        try {
          // ä¸¦è¡ŒåŠ è¼‰æ‰€æœ‰æ•¸æ“š
          const [
            accommodationData,
            waterStationData,
            restroomData,
            showerStationData,
            medicalStationData,
          ] = await Promise.all([
            getAccommodationList(),
            getWaterRefillStationList(),
            getRestroomsList(),
            getShowerStationList(),
            getMedicalStationList(),
          ]);

          // è™•ç†ä½å®¿é»æ•¸æ“š
          if (
            accommodationData &&
            accommodationData.member &&
            accommodationData.member.length > 0
          ) {
            currentAccommodationData = accommodationData.member;
            console.log(`æˆåŠŸç²å– ${currentAccommodationData.length} ç­†ä½å®¿é»è³‡æ–™`);
            addAccommodationMarkers(currentAccommodationData);
            updateAccommodationList(currentAccommodationData);
            showToast(`æˆåŠŸè¼‰å…¥ ${currentAccommodationData.length} ç­†ä½å®¿é»è³‡æ–™`, 'success');
          } else {
            showToast('ä½å®¿é»è³‡æ–™ç‚ºç©º', 'warning');
          }

          // è™•ç†åŠ æ°´ç«™æ•¸æ“š
          console.log('åŸå§‹åŠ æ°´ç«™æ•¸æ“š:', waterStationData);
          if (waterStationData) {
            if (waterStationData.member && waterStationData.member.length > 0) {
              currentWaterStationData = waterStationData.member;
            } else if (Array.isArray(waterStationData) && waterStationData.length > 0) {
              currentWaterStationData = waterStationData;
            } else {
              currentWaterStationData = [];
            }

            if (currentWaterStationData.length > 0) {
              console.log(`æˆåŠŸç²å– ${currentWaterStationData.length} ç­†åŠ æ°´ç«™è³‡æ–™`);
              addWaterStationMarkers(currentWaterStationData);
              updateWaterStationList(currentWaterStationData);
              showToast(`æˆåŠŸè¼‰å…¥ ${currentWaterStationData.length} ç­†åŠ æ°´ç«™è³‡æ–™`, 'success');
            } else {
              console.log('åŠ æ°´ç«™è³‡æ–™ç‚ºç©º');
              showToast('åŠ æ°´ç«™è³‡æ–™ç‚ºç©º', 'warning');
            }
          }

          // è™•ç†å»æ‰€æ•¸æ“š
          console.log('åŸå§‹å»æ‰€æ•¸æ“š:', restroomData);
          if (restroomData) {
            if (restroomData.member && restroomData.member.length > 0) {
              currentRestroomData = restroomData.member;
            } else if (Array.isArray(restroomData) && restroomData.length > 0) {
              currentRestroomData = restroomData;
            } else {
              currentRestroomData = [];
            }

            if (currentRestroomData.length > 0) {
              console.log(`æˆåŠŸç²å– ${currentRestroomData.length} ç­†å»æ‰€è³‡æ–™`);
              addRestroomMarkers(currentRestroomData);
              updateRestroomList(currentRestroomData);
              showToast(`æˆåŠŸè¼‰å…¥ ${currentRestroomData.length} ç­†å»æ‰€è³‡æ–™`, 'success');
            } else {
              console.log('å»æ‰€è³‡æ–™ç‚ºç©º');
              showToast('å»æ‰€è³‡æ–™ç‚ºç©º', 'warning');
            }
          }

          if (showerStationData) {
            if (showerStationData.member && showerStationData.member.length > 0) {
              currentShowerStationData = showerStationData.member;
            } else if (Array.isArray(showerStationData) && showerStationData.length > 0) {
              currentShowerStationData = showerStationData;
            } else {
              currentShowerStationData = [];
            }

            if (currentShowerStationData.length > 0) {
              console.log(`æˆåŠŸç²å– ${currentShowerStationData.length} ç­†æ´—æ¾¡é»è³‡æ–™`);
              addShowerStationMarkers(currentShowerStationData);
              updateShowerStationList(currentShowerStationData);
              showToast(`æˆåŠŸè¼‰å…¥ ${currentShowerStationData.length} ç­†æ´—æ¾¡é»è³‡æ–™`, 'success');
            } else {
              console.log('æ´—æ¾¡é»è³‡æ–™ç‚ºç©º');
              showToast('æ´—æ¾¡é»è³‡æ–™ç‚ºç©º', 'warning');
            }
          }

          // è™•ç†é†«ç™‚ç«™æ•¸æ“š
          console.log('åŸå§‹é†«ç™‚ç«™æ•¸æ“š:', medicalStationData);
          if (medicalStationData) {
            if (medicalStationData.member && medicalStationData.member.length > 0) {
              currentMedicalStationData = medicalStationData.member;
            } else if (Array.isArray(medicalStationData) && medicalStationData.length > 0) {
              currentMedicalStationData = medicalStationData;
            } else {
              currentMedicalStationData = [];
            }

            if (currentMedicalStationData.length > 0) {
              console.log(`æˆåŠŸç²å– ${currentMedicalStationData.length} ç­†é†«ç™‚ç«™è³‡æ–™`);
              addMedicalStationMarkers(currentMedicalStationData);
              updateMedicalStationList(currentMedicalStationData);
              showToast(`æˆåŠŸè¼‰å…¥ ${currentMedicalStationData.length} ç­†é†«ç™‚ç«™è³‡æ–™`, 'success');
            } else {
              console.log('é†«ç™‚ç«™è³‡æ–™ç‚ºç©º');
              showToast('é†«ç™‚ç«™è³‡æ–™ç‚ºç©º', 'warning');
            }
          }

          // æ›´æ–°çµ±è¨ˆè³‡è¨Š
          updateStatistics(
            currentAccommodationData,
            shuttleRoutes,
            currentWaterStationData,
            currentRestroomData,
            currentShowerStationData,
            currentMedicalStationData,
          );

          // æ›´æ–°æ‰€æœ‰è¨­æ–½çš„ç°¡è¦è¦–åœ–
          updateAllSectionsView();
        } catch (error) {
          console.error('è¼‰å…¥åœ°åœ–è³‡æ–™å¤±æ•—:', error);
          showToast('è¼‰å…¥åœ°åœ–è³‡æ–™å¤±æ•—', 'error');
        }
        console.log('=== åœ°åœ–è³‡æ–™è¼‰å…¥å®Œæˆ ===');
      }

      // é¡¯ç¤ºé€šçŸ¥
      function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');

        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 py-3 px-6 rounded-lg shadow-lg transition-all duration-300 ${
          type === 'success'
            ? 'bg-green-600'
            : type === 'error'
            ? 'bg-red-600'
            : type === 'warning'
            ? 'bg-yellow-600'
            : 'bg-gray-800'
        } text-white opacity-100 translate-y-0`;

        setTimeout(() => {
          toast.className = toast.className.replace(
            'opacity-100 translate-y-0',
            'opacity-0 translate-y-10',
          );
        }, 3000);
      }

      // åˆå§‹åŒ–åœ°åœ–
      function initMap() {
        // å‰µå»ºåœ°åœ–ï¼Œä¸­å¿ƒé»è¨­åœ¨å…‰å¾©é„‰
        map = L.map('map', {
          zoomControl: false, // ç§»é™¤é è¨­çš„ç¸®æ”¾æ§åˆ¶
          attributionControl: false, // ç§»é™¤ç‰ˆæ¬Šè³‡è¨Š
        }).setView([23.6628, 121.4225], 11);

        // å‰µå»ºè‡ªå®šç¾©åœ–å±¤çª—æ ¼ä»¥æ§åˆ¶ç–Šæ”¾é †åº
        // é è¨­ overlayPane z-index æ˜¯ 400
        map.createPane('disasterPane');
        map.getPane('disasterPane').style.zIndex = 410; // ç½å®³å€åŸŸæ”¾åœ¨è¼ƒä½å±¤

        map.createPane('shuttlePane');
        map.getPane('shuttlePane').style.zIndex = 420; // æ¥é§è·¯ç·šæ”¾åœ¨è¼ƒé«˜å±¤

        // æ·»åŠ è‡ªå®šç¾©ç¸®æ”¾æ§åˆ¶åˆ°å³ä¸Šè§’
        L.control
          .zoom({
            position: 'topright',
          })
          .addTo(map);

        // æ·»åŠ åœ°åœ–åœ–å±¤
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors',
        }).addTo(map);

        // æ·»åŠ å…‰å¾©ç«è»Šç«™æ¨™è¨˜
        const stationIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: #3b82f6; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸš‚</div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        });

        L.marker([guangfuStation.lat, guangfuStation.lng], { icon: stationIcon }).addTo(map)
          .bindPopup(`
            <div class="p-2">
              <h3 class="font-bold text-lg whitespace-nowrap">${guangfuStation.name}</h3>
              <p class="text-sm text-gray-600">ä¸»è¦ä¸‹è»Šé»</p> 
            </div>
          `);

        // æ·»åŠ æ¥é§è·¯ç·š
        // addShuttleRoutes();

        // æ·»åŠ æ•‘ç½å€åŸŸ
        addDisasterArea();
      }

      // render è¯çµ¡è³‡è¨Š
      function renderContact(contact) {
        if (typeof contact !== 'object' || contact === null) {
          return contact || ''; // å¦‚æœä¸æ˜¯ç‰©ä»¶ï¼Œç›´æ¥å›å‚³
        }

        const type = contact.type;
        const value = contact.value;
        const url = contact.url;

        switch (type) {
          case 'phone':
            const tel = `+886${value.slice(1)}`;
            return `<a href="tel:${tel}" class="text-blue-600 hover:underline">${value}</a>`;
          case 'facebook':
          case 'line':
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${value}</a>`;
          case 'text':
          default:
            return value;
        }
      }

      // æ ¼å¼åŒ–æ€§åˆ¥æ™‚æ®µé¡¯ç¤º
      function formatGenderSchedule(schedule) {
        if (!schedule) return '';

        if (typeof schedule === 'string') {
          return schedule;
        }

        if (typeof schedule === 'object') {
          const parts = [];

          if (schedule.male && Array.isArray(schedule.male) && schedule.male.length > 0) {
            parts.push(`<span class="text-blue-600">ç”·æ€§:</span> ${schedule.male.join('ã€')}`);
          }

          if (schedule.female && Array.isArray(schedule.female) && schedule.female.length > 0) {
            parts.push(`<span class="text-pink-600">å¥³æ€§:</span> ${schedule.female.join('ã€')}`);
          }

          return parts.join('<br>');
        }

        return JSON.stringify(schedule);
      }

      // æ·»åŠ ä½å®¿é»æ¨™è¨˜
      function addAccommodationMarkers(accommodations) {
        if (!accommodations) return;
        accommodationMarkers.forEach((marker) => map.removeLayer(marker));
        accommodationMarkers = [];

        accommodations.forEach((accommodation) => {
          let lat, lng;

          if (
            accommodation.coordinates &&
            typeof accommodation.coordinates.lat === 'number' &&
            typeof accommodation.coordinates.lng === 'number'
          ) {
            lat = accommodation.coordinates.lat;
            lng = accommodation.coordinates.lng;
          }

          // ç¢ºä¿æˆ‘å€‘æœ‰æœ‰æ•ˆçš„åº§æ¨™
          if (isNaN(lat) || isNaN(lng)) {
            console.warn(
              `ä½å®¿é» "${accommodation.name || accommodation.æ°‘å®¿åç¨±}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•æ¨™è¨˜ã€‚`,
            );
            return; // è·³éæ­¤æ¨™è¨˜
          }

          const hasVacancy =
            accommodation.has_vacancy ?? (accommodation.availability || accommodation.å°šæœ‰ç©ºæˆ¿);
          const color = getStatusColor(hasVacancy);
          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${color}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ </div>`,
            iconSize: [25, 25],
            iconAnchor: [12.5, 12.5],
          });

          const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`
              <div class="max-w-xs">
                <h3 class="font-bold text-lg mb-2">${
                  accommodation.name || accommodation.æ°‘å®¿åç¨±
                }</h3>
                <div class="space-y-1 text-sm">
                  <div><span class="font-semibold">åœ°å€:</span> ${
                    accommodation.address || accommodation.åœ°å€ || 'æœªæä¾›'
                  }</div>
                  <div><span class="font-semibold">è¯çµ¡:</span> ${renderContact(
                    accommodation.contact_info || accommodation['è¯ç¹«æ–¹å¼'],
                  )}</div>
                  ${
                    accommodation.pricing || accommodation.è²»ç”¨ || accommodation.cost
                      ? `<div><span class="font-semibold">è²»ç”¨:</span> ${
                          accommodation.pricing || accommodation.è²»ç”¨ || accommodation.cost
                        }</div>`
                      : ''
                  }
                  ${
                    accommodation.notes || accommodation['æ™‚é–“ã€æˆ¿å‹']
                      ? `<div><span class="font-semibold">å‚™è¨»:</span> ${
                          accommodation.notes || accommodation['æ™‚é–“ã€æˆ¿å‹']
                        }</div>`
                      : ''
                  }
                  ${
                    accommodation.source_link || accommodation.è³‡æ–™ä¾†æº
                      ? `<div><span class="font-semibold">è³‡æ–™ä¾†æº:</span> <a href="${
                          accommodation.source_link
                        }" target="_blank" rel="noopener noreferrer">${
                          accommodation.source_link || 'é€£çµ'
                        }</a></div>`
                      : ''
                  }
                  ${
                    accommodation.last_updated
                      ? `<div><span class="font-semibold">æœ€å¾Œæ›´æ–°:</span> ${accommodation.last_updated}</div>`
                      : ''
                  }
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                  <button onclick="openReportIssueModal('ä½å®¿é»', '${
                    accommodation.id || 'unknown'
                  }', '${(accommodation.name || accommodation.æ°‘å®¿åç¨± || 'æœªçŸ¥ä½å®¿é»').replace(
            /'/g,
            "\\'",
          )}')" class="w-full px-3 py-2 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 transition-colors">
                    å›å ±å•é¡Œ
                  </button>
                </div>
              </div>
            `);

          // Attach original data to the marker for later use
          marker.accommodationData = accommodation;
          accommodationMarkers.push(marker);
        });
      }

      // æ·»åŠ åŠ æ°´ç«™æ¨™è¨˜
      function addWaterStationMarkers(waterStations) {
        if (!waterStations) return;
        waterStationMarkers.forEach((marker) => map.removeLayer(marker));
        waterStationMarkers = [];

        waterStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`åŠ æ°´ç«™ "${station.name}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•æ¨™è¨˜ã€‚`);
            return;
          }

          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #06b6d4; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ’§</div>`,
            iconSize: [25, 25],
            iconAnchor: [12.5, 12.5],
          });

          const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`
              <div class="max-w-xs">
                <h3 class="font-bold text-lg mb-2">${station.name || '-'}</h3>
                <div class="space-y-1 text-sm">
                  <div><span class="font-semibold">åœ°å€:</span> ${station.address || '-'}</div>
                  ${
                    station.opening_hours
                      ? `<div><span class="font-semibold">é–‹æ”¾æ™‚é–“:</span> ${
                          station.opening_hours || '-'
                        }</div>`
                      : ''
                  }
                  ${
                    station.contact
                      ? `<div><span class="font-semibold">è¯çµ¡:</span> ${
                          station.contact || '-'
                        }</div>`
                      : ''
                  }
                  ${
                    station.notes
                      ? `<div><span class="font-semibold">å‚™è¨»:</span> ${
                          station.notes || '-'
                        }</div>`
                      : ''
                  }
                  ${
                    station.is_free
                      ? `<div><span class="font-semibold">æ˜¯å¦å…è²»:</span> ${
                          station.is_free ? 'æ˜¯' : 'å¦'
                        }</div>`
                      : ''
                  }
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                  <button onclick="openReportIssueModal('åŠ æ°´ç«™', '${station.id || 'unknown'}', '${(
            station.name || 'æœªçŸ¥åŠ æ°´ç«™'
          ).replace(
            /'/g,
            "\\'",
          )}')" class="w-full px-3 py-2 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 transition-colors">
                    å›å ±å•é¡Œ
                  </button>
                </div>
              </div>
            `);

          marker.stationData = station;
          waterStationMarkers.push(marker);
        });
      }

      // æ·»åŠ å»æ‰€æ¨™è¨˜
      function addRestroomMarkers(restrooms) {
        if (!restrooms) return;
        restroomMarkers.forEach((marker) => map.removeLayer(marker));
        restroomMarkers = [];

        restrooms.forEach((restroom) => {
          let lat, lng;
          if (restroom.coordinates) {
            lat = restroom.coordinates.lat;
            lng = restroom.coordinates.lng;
          } else if (restroom.lat && restroom.lng) {
            lat = parseFloat(restroom.lat);
            lng = parseFloat(restroom.lng);
          }

          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`å»æ‰€ "${restroom.name}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•æ¨™è¨˜ã€‚`);
            return;
          }

          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #8b5cf6; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸš»</div>`,
            iconSize: [25, 25],
            iconAnchor: [12.5, 12.5],
          });

          const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`
              <div class="max-w-xs">
                <h3 class="font-bold text-lg mb-2">${restroom.name}</h3>
                <div class="space-y-1 text-sm">
                  <div><span class="font-semibold">åœ°å€:</span> ${
                    restroom.address || 'æœªæä¾›'
                  }</div>
                  ${
                    restroom.hours
                      ? `<div><span class="font-semibold">é–‹æ”¾æ™‚é–“:</span> ${restroom.hours}</div>`
                      : ''
                  }
                  ${
                    restroom.facilities
                      ? `<div><span class="font-semibold">è¨­æ–½:</span> ${restroom.facilities}</div>`
                      : ''
                  }
                  ${
                    restroom.notes
                      ? `<div><span class="font-semibold">å‚™è¨»:</span> ${restroom.notes}</div>`
                      : ''
                  }
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                  <button onclick="openReportIssueModal('å»æ‰€', '${restroom.id || 'unknown'}', '${(
            restroom.name || 'æœªçŸ¥å»æ‰€'
          ).replace(
            /'/g,
            "\\'",
          )}')" class="w-full px-3 py-2 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 transition-colors">
                    å›å ±å•é¡Œ
                  </button>
                </div>
              </div>
            `);

          marker.restroomData = restroom;
          restroomMarkers.push(marker);
        });
      }

      // æ·»åŠ æ´—æ¾¡é»æ¨™è¨˜
      function addShowerStationMarkers(showerStations) {
        if (!showerStations) return;
        showerStationMarkers.forEach((marker) => map.removeLayer(marker));
        showerStationMarkers = [];

        showerStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`æ´—æ¾¡é» "${station.name}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•æ¨™è¨˜ã€‚`);
            return;
          }

          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #f59e0b; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸš¿</div>`,
            iconSize: [25, 25],
            iconAnchor: [12.5, 12.5],
          });

          const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`
              <div class="max-w-xs">
                <h3 class="font-bold text-lg mb-2">${station.name}</h3>
                <div class="space-y-1 text-sm">
                  <div><span class="font-semibold">åœ°å€:</span> ${station.address || 'æœªæä¾›'}</div>
                  ${
                    station.facility_type
                      ? `<div><span class="font-semibold">è¨­æ–½é¡å‹:</span> ${station.facility_type}</div>`
                      : ''
                  }
                  ${
                    station.time_slots
                      ? `<div><span class="font-semibold">é–‹æ”¾æ™‚æ®µ:</span> ${station.time_slots}</div>`
                      : ''
                  }
                  ${
                    station.gender_schedule
                      ? `<div><span class="font-semibold">æ€§åˆ¥æ™‚æ®µ:</span><br>${formatGenderSchedule(
                          station.gender_schedule,
                        )}</div>`
                      : ''
                  }
                  ${
                    station.capacity
                      ? `<div><span class="font-semibold">å®¹ç´äººæ•¸:</span> ${station.capacity}äºº</div>`
                      : ''
                  }
                  ${
                    station.is_free !== undefined
                      ? `<div><span class="font-semibold">æ˜¯å¦å…è²»:</span> ${
                          station.is_free ? 'æ˜¯' : 'å¦'
                        }</div>`
                      : ''
                  }
                  ${
                    station.pricing
                      ? `<div><span class="font-semibold">è²»ç”¨èªªæ˜:</span> ${station.pricing}</div>`
                      : ''
                  }
                  ${
                    station.facilities && Array.isArray(station.facilities)
                      ? `<div><span class="font-semibold">é¡å¤–è¨­æ–½:</span> ${station.facilities.join(
                          ', ',
                        )}</div>`
                      : ''
                  }
                  ${
                    station.requires_appointment !== undefined
                      ? `<div><span class="font-semibold">æ˜¯å¦éœ€é ç´„:</span> ${
                          station.requires_appointment ? 'æ˜¯' : 'å¦'
                        }</div>`
                      : ''
                  }
                  ${
                    station.contact_method
                      ? `<div><span class="font-semibold">è¯çµ¡æ–¹å¼:</span> ${station.contact_method}</div>`
                      : ''
                  }
                  ${
                    station.notes
                      ? `<div><span class="font-semibold">å‚™è¨»:</span> ${station.notes}</div>`
                      : ''
                  }
                  ${
                    station.distance_to_guangfu
                      ? `<div><span class="font-semibold">è·å…‰å¾©:</span> ${station.distance_to_guangfu}</div>`
                      : ''
                  }
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                  <button onclick="openReportIssueModal('æ´—æ¾¡é»', '${station.id || 'unknown'}', '${(
            station.name || 'æœªçŸ¥æ´—æ¾¡é»'
          ).replace(
            /'/g,
            "\\'",
          )}')" class="w-full px-3 py-2 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 transition-colors">
                    å›å ±å•é¡Œ
                  </button>
                </div>
              </div>
            `);

          marker.showerStationData = station;
          showerStationMarkers.push(marker);
        });
      }

      // æ·»åŠ é†«ç™‚ç«™æ¨™è¨˜
      function addMedicalStationMarkers(medicalStations) {
        if (!medicalStations) return;
        medicalStationMarkers.forEach((marker) => map.removeLayer(marker));
        medicalStationMarkers = [];

        medicalStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`é†«ç™‚ç«™ "${station.name}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•æ¨™è¨˜ã€‚`);
            return;
          }

          const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: #ef4444; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ¥</div>`,
            iconSize: [25, 25],
            iconAnchor: [12.5, 12.5],
          });

          const marker = L.marker([lat, lng], { icon }).addTo(map).bindPopup(`
              <div class="max-w-xs">
                <h3 class="font-bold text-lg mb-2">${station.name}</h3>
                <div class="space-y-1 text-sm">
                  <div><span class="font-semibold">åœ°å€:</span> ${
                    station.detailed_address || 'æœªæä¾›'
                  }</div> 
                  ${
                    !!station.services.join('')
                      ? `<div><span class="font-semibold">æœå‹™é …ç›®:</span> ${station.services.join(
                          ', \r\n',
                        )}</div>`
                      : ''
                  }
                  ${
                    station.contact_person
                      ? `<div><span class="font-semibold">è¯çµ¡:</span> ${station.contact_person}</div>`
                      : ''
                  }
                  ${
                    station.phone
                      ? `<div><span class="font-semibold">è¯çµ¡:</span> ${station.phone}</div>`
                      : ''
                  }
                  ${
                    station.notes
                      ? `<div><span class="font-semibold">å‚™è¨»:</span> ${station.notes}</div>`
                      : ''
                  }
                </div>
                <div class="mt-3 pt-2 border-t border-gray-200">
                  <button onclick="openReportIssueModal('é†«ç™‚ç«™', '${station.id || 'unknown'}', '${(
            station.name || 'æœªçŸ¥é†«ç™‚ç«™'
          ).replace(
            /'/g,
            "\\'",
          )}')" class="w-full px-3 py-2 bg-orange-500 text-white text-sm rounded-md hover:bg-orange-600 transition-colors">
                    å›å ±å•é¡Œ
                  </button>
                </div>
              </div>
            `);

          marker.stationData = station;
          medicalStationMarkers.push(marker);
        });
      }

      // æ·»åŠ æ¥é§è·¯ç·š
      //   function addShuttleRoutes() {
      //     shuttlePolylines.forEach(p => map.removeLayer(p));
      //     shuttlePolylines = [];

      //     shuttleRoutes.forEach(routeInfo => {
      //       const polyline = L.polyline(routeInfo.route, {
      //         color: '#8b5cf6',
      //         weight: 4,
      //         opacity: 0.8,
      //         dashArray: '10, 5',
      //         pane: 'shuttlePane' // æŒ‡å®šçª—æ ¼
      //       }).addTo(map);

      //       polyline.bindPopup(`
      //         <div class="p-2 max-w-xs">
      //           <h3 class="font-bold text-lg mb-2">æ¥é§è·¯ç·š</h3>
      //           <div class="space-y-1 text-sm">
      //             <div><span class="font-semibold">å‡ºç™¼é»:</span> ${routeInfo.å‡ºç™¼åœ°é»}</div>
      //             <div><span class="font-semibold">ç›®çš„åœ°:</span> ${routeInfo.ç›®çš„åœ°}</div>
      //             <div><span class="font-semibold">å‡ºç™¼æ™‚é–“:</span> ${routeInfo.å‡ºç™¼æ™‚é–“}</div>
      //             ${routeInfo.è¯çµ¡äºº && routeInfo.è¯çµ¡äºº.text ? `<div><span class="font-semibold">è¯çµ¡äºº:</span> <a href="${routeInfo.è¯çµ¡äºº.url}" target="_blank" class="text-blue-600 hover:underline">${routeInfo.è¯çµ¡äºº.text}</a></div>` : ''}
      //             ${routeInfo.å‚™è¨» ? `<div><span class="font-semibold">å‚™è¨»:</span> ${routeInfo.å‚™è¨».replace(/\r\n/g, '<br>')}</div>` : ''}
      //           </div>
      //         </div>
      //       `);
      //       shuttlePolylines.push(polyline);
      //     });
      //   }

      // æ·»åŠ æ•‘ç½å€åŸŸ
      function addDisasterArea() {
        if (disasterPolygon) map.removeLayer(disasterPolygon);

        disasterPolygon = L.polygon(disasterArea, {
          color: '#ec4899',
          weight: 2,
          opacity: 0.8,
          fillColor: '#ec4899',
          fillOpacity: 0.2,
          pane: 'disasterPane', // æŒ‡å®šçª—æ ¼
        }).addTo(map);

        disasterPolygon.bindPopup(`
          <div class="p-2">
            <h3 class="font-bold">æ•‘ç½å€åŸŸç¯„åœ</h3>
            <p class="text-sm">ä¸»è¦ç½å®³å½±éŸ¿å€åŸŸ</p>
            <p class="text-sm text-gray-600">è«‹æ³¨æ„å®‰å…¨</p>
          </div>
        `);
      }

      // ç²å–ç‹€æ…‹é¡è‰²
      function getStatusColor(hasVacancy) {
        if (typeof hasVacancy === 'boolean') {
          return hasVacancy ? '#10b981' : '#ef4444'; // Green for true, Red for false
        }
        // Fallback for string-based availability
        if (typeof hasVacancy === 'string') {
          const lowerAvailability = hasVacancy.toLowerCase();
          if (lowerAvailability.includes('æœ‰')) return '#10b981'; // Green for "Available"
          if (lowerAvailability.includes('æ»¿') || lowerAvailability.includes('ç„¡'))
            return '#ef4444'; // Red for "Full" or "None"
          if (lowerAvailability.includes('æœªçŸ¥')) return '#f59e0b'; // Amber for "Unknown"
        }
        return '#6b7280'; // Default gray for undefined or other cases
      }

      // æ›´æ–°çµ±è¨ˆè³‡è¨Š
      function updateStatistics(
        accommodations,
        shuttleRoutes,
        waterStations,
        restrooms,
        showerStations,
        medicalStations,
      ) {
        if (accommodations) {
          const total = accommodations.length;
          document.getElementById('totalAccommodations').textContent = total;
        }
        if (waterStations) {
          document.getElementById('totalWaterStations').textContent = waterStations.length;
        }
        if (restrooms) {
          document.getElementById('totalRestrooms').textContent = restrooms.length;
        }
        if (showerStations) {
          document.getElementById('totalShowerStations').textContent = showerStations.length;
        }
        if (medicalStations) {
          document.getElementById('totalMedicalStations').textContent = medicalStations.length;
        }
        // if (shuttleRoutes) {
        //   const totalRoutes = shuttleRoutes.length;
        //   document.getElementById('totalShuttleRoutes').textContent = totalRoutes;
        // }
      }

      // æ›´æ–°ä½å®¿é»åˆ—è¡¨
      function updateAccommodationList(accommodations) {
        const container = document.getElementById('accommodationList');
        container.innerHTML = '';
        if (!accommodations) return;

        accommodations.forEach((accommodation) => {
          const hasVacancy =
            accommodation.has_vacancy ?? (accommodation.availability || accommodation.å°šæœ‰ç©ºæˆ¿);
          const color = getStatusColor(hasVacancy);

          let lat, lng;
          if (accommodation.coordinates) {
            lat = accommodation.coordinates.lat;
            lng = accommodation.coordinates.lng;
          } else return;

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const accommodationName = accommodation.name || '-';
          const accommodationAddress = accommodation.address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${accommodationName}</h4>
                <p class="text-sm text-gray-600 truncate">${accommodationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a> 
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.closest('a')) return; // Do not trigger if clicking the link

            const marker = accommodationMarkers.find((m) => m.accommodationData === accommodation);
            if (marker) {
              map.flyTo(marker.getLatLng(), 15);
              marker.openPopup();
              if (window.innerWidth <= 768) {
                closeInfoSidebar();
              }
            }
          });
          container.appendChild(element);
        });
      }

      // æ›´æ–°åŠ æ°´ç«™åˆ—è¡¨
      function updateWaterStationList(waterStations) {
        const container = document.getElementById('waterStationList');
        container.innerHTML = '';
        if (!waterStations) return;

        waterStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const stationName = station.name || 'æœªçŸ¥åŠ æ°´ç«™';
          const stationAddress = station.address || 'æœªæä¾›åœ°å€';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.closest('a')) return;
            const marker = waterStationMarkers.find((m) => m.stationData === station);
            if (marker) {
              map.flyTo(marker.getLatLng(), 15);
              marker.openPopup();
              if (window.innerWidth <= 768) {
                closeInfoSidebar();
              }
            }
          });
          container.appendChild(element);
        });
      }

      // æ›´æ–°å»æ‰€åˆ—è¡¨
      function updateRestroomList(restrooms) {
        const container = document.getElementById('restroomList');
        container.innerHTML = '';
        if (!restrooms) return;

        restrooms.forEach((restroom) => {
          let lat, lng;
          if (restroom.coordinates) {
            lat = restroom.coordinates.lat;
            lng = restroom.coordinates.lng;
          } else if (restroom.lat && restroom.lng) {
            lat = parseFloat(restroom.lat);
            lng = parseFloat(restroom.lng);
          }

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const restroomName = restroom.name || 'æœªçŸ¥å»æ‰€';
          const restroomAddress = restroom.address || 'æœªæä¾›åœ°å€';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${restroomName}</h4>
                <p class="text-sm text-gray-600 truncate">${restroomAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.closest('a')) return;
            const marker = restroomMarkers.find((m) => m.restroomData === restroom);
            if (marker) {
              map.flyTo(marker.getLatLng(), 15);
              marker.openPopup();
              if (window.innerWidth <= 768) {
                closeInfoSidebar();
              }
            }
          });
          container.appendChild(element);
        });
      }

      // æ›´æ–°æ´—æ¾¡é»åˆ—è¡¨
      function updateShowerStationList(showerStations) {
        const container = document.getElementById('showerStationList');
        container.innerHTML = '';
        if (!showerStations) return;

        showerStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const stationName = station.name || 'æœªçŸ¥æ´—æ¾¡é»';
          const stationAddress = station.address || 'æœªæä¾›åœ°å€';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
                ${
                  station.facility_type
                    ? `<p class="text-xs text-gray-500 mt-1">é¡å‹: ${station.facility_type}</p>`
                    : ''
                }
                ${
                  station.time_slots
                    ? `<p class="text-xs text-gray-500">æ™‚æ®µ: ${station.time_slots}</p>`
                    : ''
                }
                ${
                  station.capacity
                    ? `<p class="text-xs text-gray-500">å®¹ç´: ${station.capacity}äºº</p>`
                    : ''
                }
                ${
                  station.is_free !== undefined
                    ? `<p class="text-xs ${
                        station.is_free ? 'text-green-600' : 'text-orange-600'
                      }">${station.is_free ? 'å…è²»' : 'æ”¶è²»'}</p>`
                    : ''
                }
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.closest('a')) return; // Do not trigger if clicking the link

            const marker = showerStationMarkers.find((m) => m.showerStationData === station);
            if (marker) {
              map.flyTo(marker.getLatLng(), 15);
              marker.openPopup();
              if (window.innerWidth <= 768) {
                closeInfoSidebar();
              }
            }
          });
          container.appendChild(element);
        });
      }

      // æ›´æ–°é†«ç™‚ç«™åˆ—è¡¨
      function updateMedicalStationList(medicalStations) {
        const container = document.getElementById('medicalStationList');
        container.innerHTML = '';
        if (!medicalStations) return;

        medicalStations.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          if (isNaN(lat) || isNaN(lng)) {
            console.warn(`é†«ç™‚ç«™ "${station.name}" ç¼ºå°‘æœ‰æ•ˆçš„åº§æ¨™ç„¡æ³•åœ¨åˆ—è¡¨ä¸­é¡¯ç¤ºã€‚`);
            return;
          }

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const stationName = station.name || 'æœªçŸ¥é†«ç™‚ç«™';
          const stationAddress = station.detailed_address || 'æœªæä¾›åœ°å€';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.closest('a')) return;
            const marker = medicalStationMarkers.find((m) => m.stationData === station);
            if (marker) {
              map.flyTo(marker.getLatLng(), 15);
              marker.openPopup();
              if (window.innerWidth <= 768) {
                closeInfoSidebar();
              }
            }
          });
          container.appendChild(element);
        });
      }

      // æ›´æ–°åˆ—è¡¨é¡¯ç¤ºï¼ˆæ ¹æ“šç•¶å‰é¸æ“‡çš„åˆ†é¡ï¼‰
      function updateListDisplay(layerType) {
        const sections = [
          'accommodationSection',
          'waterStationSection',
          'restroomSection',
          'showerStationSection',
          'medicalStationSection',
          'allSections',
        ];

        // éš±è—æ‰€æœ‰éƒ¨åˆ†
        sections.forEach((sectionId) => {
          const section = document.getElementById(sectionId);
          if (section) section.style.display = 'none';
        });

        // é¡¯ç¤ºå°æ‡‰çš„éƒ¨åˆ†
        switch (layerType) {
          case 'accommodation':
            document.getElementById('accommodationSection').style.display = 'block';
            break;
          case 'waterStation':
            document.getElementById('waterStationSection').style.display = 'block';
            break;
          case 'restroom':
            document.getElementById('restroomSection').style.display = 'block';
            break;
          case 'showerStation':
            document.getElementById('showerStationSection').style.display = 'block';
            break;
          case 'medicalStation':
            document.getElementById('medicalStationSection').style.display = 'block';
            break;
          case 'all':
          default:
            document.getElementById('allSections').style.display = 'block';
            updateAllSectionsView(); // æ›´æ–°æ‰€æœ‰è¨­æ–½çš„ç°¡è¦è¦–åœ–
            break;
        }
      }

      // æ›´æ–°æ‰€æœ‰è¨­æ–½çš„å®Œæ•´è¦–åœ–
      function updateAllSectionsView() {
        console.log('=== æ›´æ–°æ‰€æœ‰è¨­æ–½è¦–åœ– ===');
        console.log(
          'currentAccommodationData:',
          currentAccommodationData ? currentAccommodationData.length : 'null',
        );
        console.log(
          'currentWaterStationData:',
          currentWaterStationData ? currentWaterStationData.length : 'null',
        );
        console.log(
          'currentRestroomData:',
          currentRestroomData ? currentRestroomData.length : 'null',
        );
        console.log(
          'currentShowerStationData:',
          currentShowerStationData ? currentShowerStationData.length : 'null',
        );
        console.log(
          'currentMedicalStationData:',
          currentMedicalStationData ? currentMedicalStationData.length : 'null',
        );

        // æ›´æ–°ä½å®¿é»å®Œæ•´åˆ—è¡¨
        updateAllAccommodationSection();

        // æ›´æ–°åŠ æ°´ç«™å®Œæ•´åˆ—è¡¨
        updateAllWaterStationSection();

        // æ›´æ–°å»æ‰€å®Œæ•´åˆ—è¡¨
        updateAllRestroomSection();

        // æ›´æ–°æ´—æ¾¡é»å®Œæ•´åˆ—è¡¨
        updateAllShowerStationSection();

        // æ›´æ–°é†«ç™‚ç«™å®Œæ•´åˆ—è¡¨
        updateAllMedicalStationSection();

        console.log('=== æ‰€æœ‰è¨­æ–½è¦–åœ–æ›´æ–°å®Œæˆ ===');
      }

      // æ›´æ–°ä½å®¿é»éƒ¨åˆ†
      function updateAllAccommodationSection() {
        const container = document.getElementById('allAccommodationContent');
        const countElement = document.getElementById('allAccommodationCount');

        container.innerHTML = '';
        if (!currentAccommodationData || currentAccommodationData.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-400">æš«ç„¡æ•¸æ“š</div>';
          countElement.textContent = '(0)';
          return;
        }

        countElement.textContent = `(${currentAccommodationData.length})`;

        currentAccommodationData.forEach((accommodation) => {
          const hasVacancy =
            accommodation.has_vacancy ?? (accommodation.availability || accommodation.å°šæœ‰ç©ºæˆ¿);
          const color = getStatusColor(hasVacancy);

          let lat, lng;
          if (accommodation.coordinates) {
            lat = accommodation.coordinates.lat;
            lng = accommodation.coordinates.lng;
          } else return;

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const accommodationName = accommodation.name || '-';
          const accommodationAddress = accommodation.address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${accommodationName}</h4>
                <p class="text-sm text-gray-600 truncate">${accommodationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a> 
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              const marker = accommodationMarkers.find(
                (m) => m.accommodationData === accommodation,
              );
              if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
              }
            }
          });

          container.appendChild(element);
        });
      }

      // æ›´æ–°åŠ æ°´ç«™éƒ¨åˆ†
      function updateAllWaterStationSection() {
        console.log('=== æ›´æ–°åŠ æ°´ç«™éƒ¨åˆ† ===');
        const container = document.getElementById('allWaterStationContent');
        const countElement = document.getElementById('allWaterStationCount');

        container.innerHTML = '';
        if (!currentWaterStationData || currentWaterStationData.length === 0) {
          console.log('åŠ æ°´ç«™æ•¸æ“šç‚ºç©º');
          container.innerHTML = '<div class="text-sm text-gray-400">æš«ç„¡æ•¸æ“š</div>';
          countElement.textContent = '(0)';
          return;
        }

        countElement.textContent = `(${currentWaterStationData.length})`;

        currentWaterStationData.forEach((station) => {
          const lat = station?.coordinates?.lat;
          const lng = station?.coordinates?.lng;
          if (!lat || !lng) return;

          const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
          const stationName = station.name || 'æœªçŸ¥åŠ æ°´ç«™';
          const stationAddress = station.address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              const marker = waterStationMarkers.find((m) => m.stationData === station);
              if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
              }
            }
          });

          container.appendChild(element);
        });
      }

      // æ›´æ–°å»æ‰€éƒ¨åˆ†
      function updateAllRestroomSection() {
        const container = document.getElementById('allRestroomContent');
        const countElement = document.getElementById('allRestroomCount');

        container.innerHTML = '';
        if (!currentRestroomData || currentRestroomData.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-400">æš«ç„¡æ•¸æ“š</div>';
          countElement.textContent = '(0)';
          return;
        }

        countElement.textContent = `(${currentRestroomData.length})`;

        currentRestroomData.forEach((restroom) => {
          const lat = restroom?.coordinates?.lat;
          const lng = restroom?.coordinates?.lng;
          if (!lat || !lng) return;

          const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
          const restroomName = restroom.name || 'æœªçŸ¥å»æ‰€';
          const restroomAddress = restroom.address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${restroomName}</h4>
                <p class="text-sm text-gray-600 truncate">${restroomAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              const marker = restroomMarkers.find((m) => m.restroomData === restroom);
              if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
              }
            }
          });

          container.appendChild(element);
        });
      }

      // æ›´æ–°æ´—æ¾¡é»éƒ¨åˆ†
      function updateAllShowerStationSection() {
        const container = document.getElementById('allShowerStationContent');
        const countElement = document.getElementById('allShowerStationCount');

        container.innerHTML = '';
        if (!currentShowerStationData || currentShowerStationData.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-400">æš«ç„¡æ•¸æ“š</div>';
          countElement.textContent = '(0)';
          return;
        }

        countElement.textContent = `(${currentShowerStationData.length})`;

        currentShowerStationData.forEach((station) => {
          let lat, lng;
          if (station.coordinates) {
            lat = station.coordinates.lat;
            lng = station.coordinates.lng;
          } else if (station.lat && station.lng) {
            lat = parseFloat(station.lat);
            lng = parseFloat(station.lng);
          }

          const googleMapsUrl =
            lat && !isNaN(lat) && lng && !isNaN(lng)
              ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`
              : '#';
          const stationName = station.name || 'æœªçŸ¥æ´—æ¾¡é»';
          const stationAddress = station.address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
                ${
                  station.facility_type
                    ? `<p class="text-xs text-gray-500">é¡å‹: ${station.facility_type}</p>`
                    : ''
                }
                ${
                  station.is_free !== undefined
                    ? `<p class="text-xs ${
                        station.is_free ? 'text-green-600' : 'text-orange-600'
                      }">${station.is_free ? 'å…è²»' : 'æ”¶è²»'}</p>`
                    : ''
                }
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              const marker = showerStationMarkers.find((m) => m.showerStationData === station);
              if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
              }
            }
          });

          container.appendChild(element);
        });
      }

      // æ›´æ–°é†«ç™‚ç«™éƒ¨åˆ†
      function updateAllMedicalStationSection() {
        const container = document.getElementById('allMedicalStationContent');
        const countElement = document.getElementById('allMedicalStationCount');

        container.innerHTML = '';
        if (!currentMedicalStationData || currentMedicalStationData.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-400">æš«ç„¡æ•¸æ“š</div>';
          countElement.textContent = '(0)';
          return;
        }

        countElement.textContent = `(${currentMedicalStationData.length})`;

        currentMedicalStationData.forEach((station) => {
          const lat = station?.coordinates?.lat;
          const lng = station?.coordinates?.lng;
          if (!lat || !lng) return;

          const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
          const stationName = station.name || 'æœªçŸ¥é†«ç™‚ç«™';
          const stationAddress = station.detailed_address || '-';

          const element = document.createElement('div');
          element.className =
            'p-3 rounded-lg hover:bg-gray-100 cursor-pointer border-b border-gray-200';
          element.innerHTML = `
            <div class="flex items-center gap-1"> 
              <div class="flex-1 min-w-0">
                <h4 class="font-semibold text-gray-800 truncate">${stationName}</h4>
                <p class="text-sm text-gray-600 truncate">${stationAddress}</p>
              </div>
              <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline text-sm font-medium" title="åœ¨ Google åœ°åœ–ä¸ŠæŸ¥çœ‹">
                å°èˆª
              </a>
            </div>
          `;

          element.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
              const marker = medicalStationMarkers.find((m) => m.stationData === station);
              if (marker) {
                map.flyTo(marker.getLatLng(), 15);
                marker.openPopup();
              }
            }
          });

          container.appendChild(element);
        });
      }

      // å®šä½åˆ°æŒ‡å®šä½ç½®
      function focusOnLocation(lat, lng) {
        map.setView([lat, lng], 15);
        showToast('å·²å®šä½åˆ°æŒ‡å®šä½ç½®', 'success');
      }

      // ç²å–ç”¨æˆ¶ä½ç½®ï¼ˆåƒ…ç²å–åº§æ¨™ï¼Œä¸é¡¯ç¤ºï¼‰
      function requestUserLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½'));
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              userPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              hasLocationPermission = true;

              // æ›´æ–°æŒ‰éˆ•æ¨£å¼ç‚ºæœ‰å®šä½ç‹€æ…‹
              const btn = document.getElementById('locateUserBtn');
              btn.classList.add('has-location');
              btn.title = 'å®šä½ï¼ˆé•·æŒ‰è¿½è¹¤ï¼‰';

              // é¡¯ç¤ºäººåŠ›è«‹æ±‚æŒ‰éˆ•
              // updateLocationButtonsVisibility();

              resolve(userPosition);
            },
            (error) => {
              hasLocationPermission = false;

              // æ›´æ–°æŒ‰éˆ•æ¨£å¼ç‚ºç„¡å®šä½ç‹€æ…‹
              const btn = document.getElementById('locateUserBtn');
              btn.classList.remove('has-location');
              btn.classList.remove('active');

              let message = 'ç„¡æ³•ç²å–æ‚¨çš„ä½ç½®';
              console.error('åœ°ç†ä½ç½®éŒ¯èª¤:', error);

              switch (error.code) {
                case error.PERMISSION_DENIED:
                  message = 'å®šä½æ¬Šé™è¢«æ‹’çµ•ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­ç½®ä¸¦å…è¨±ä½ç½®è¨ªå•';
                  console.error(
                    'ä½ç½®æ¬Šé™è¢«æ‹’çµ•ã€‚å¯èƒ½åŸå› ï¼š1) ç”¨æˆ¶æ‹’çµ• 2) æ¬Šé™æ”¿ç­–é˜»æ­¢ 3) éHTTPSç’°å¢ƒ',
                  );
                  break;
                case error.POSITION_UNAVAILABLE:
                  message = 'ä½ç½®è³‡è¨Šç„¡æ³•ä½¿ç”¨ï¼Œè«‹ç¢ºä¿GPSå·²é–‹å•Ÿ';
                  break;
                case error.TIMEOUT:
                  message = 'å®šä½è«‹æ±‚è¶…æ™‚ï¼Œè«‹é‡è©¦';
                  break;
                default:
                  message = `å®šä½éŒ¯èª¤ (ä»£ç¢¼: ${error.code}): ${error.message}`;
              }
              reject(new Error(message));
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 300000,
            },
          );
        });
      }

      // é–‹å§‹å¯¦æ™‚ä½ç½®è¿½è¹¤
      async function startWatchingPosition(showConfirm = false) {
        if (!navigator.geolocation || isWatchingPosition) return;

        // å¦‚æœéœ€è¦é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        if (showConfirm) {
          const confirmed = await customConfirm(
            'æ˜¯å¦é–‹å•Ÿå¯¦æ™‚ä½ç½®è¿½è¹¤ï¼Ÿé€™å°‡æŒçºŒæ›´æ–°æ‚¨åœ¨åœ°åœ–ä¸Šçš„ä½ç½®ã€‚',
            'ä½ç½®è¿½è¹¤ç¢ºèª',
          );
          if (!confirmed) {
            return;
          }
        }

        isWatchingPosition = true;

        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const newPosition = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // æ›´æ–°ç”¨æˆ¶ä½ç½®
            userPosition = newPosition;

            // å¦‚æœä½ç½®æ¨™è¨˜æ­£åœ¨é¡¯ç¤ºï¼Œæ›´æ–°å®ƒ
            if (isLocationVisible && userLocationMarker) {
              userLocationMarker.setLatLng([newPosition.lat, newPosition.lng]);
            }

            console.log('ä½ç½®å·²æ›´æ–°:', newPosition);
          },
          (error) => {
            console.error('ä½ç½®è¿½è¹¤éŒ¯èª¤:', error);
            stopWatchingPosition();
            showToast('ä½ç½®è¿½è¹¤å¤±æ•—', 'error');
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000, // 1åˆ†é˜å…§çš„ä½ç½®æ•¸æ“šä»æœ‰æ•ˆ
          },
        );

        showToast('å·²é–‹å•Ÿå¯¦æ™‚ä½ç½®è¿½è¹¤', 'success');

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        const btn = document.getElementById('locateUserBtn');
        btn.classList.add('tracking');
        btn.title = 'åœæ­¢è¿½è¹¤ä½ç½®ï¼ˆé•·æŒ‰ï¼‰';
      }

      // åœæ­¢å¯¦æ™‚ä½ç½®è¿½è¹¤
      function stopWatchingPosition() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          isWatchingPosition = false;

          showToast('å·²åœæ­¢ä½ç½®è¿½è¹¤', 'info');

          // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          const btn = document.getElementById('locateUserBtn');
          btn.classList.remove('tracking');
          if (hasLocationPermission) {
            btn.title = 'å®šä½ï¼ˆé•·æŒ‰è¿½è¹¤ï¼‰';
          }
        }
      }

      // é¡¯ç¤ºç”¨æˆ¶ä½ç½®æ¨™è¨˜
      function showUserLocation() {
        if (!userPosition) return;

        // ç§»é™¤èˆŠçš„æ¨™è¨˜
        if (userLocationMarker) {
          map.removeLayer(userLocationMarker);
        }

        // å‰µå»ºç”¨æˆ¶ä½ç½®æ¨™è¨˜
        const userIcon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">ğŸ“</div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10],
        });

        userLocationMarker = L.marker([userPosition.lat, userPosition.lng], {
          icon: userIcon,
        }).addTo(map).bindPopup(`
            <div class="p-2">
              <h3 class="font-bold">æ‚¨çš„ä½ç½®</h3>
              <p class="text-sm">ç·¯åº¦: ${userPosition.lat.toFixed(6)}</p>
              <p class="text-sm">ç¶“åº¦: ${userPosition.lng.toFixed(6)}</p>
            </div>
          `);

        // å°‡åœ°åœ–ä¸­å¿ƒç§»å‹•åˆ°ç”¨æˆ¶ä½ç½®
        map.setView([userPosition.lat, userPosition.lng], 13);
        isLocationVisible = true;

        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        const btn = document.getElementById('locateUserBtn');
        btn.classList.add('has-location');
        btn.classList.add('active');
        btn.title = 'éš±è—å®šä½';

        // é¡¯ç¤ºäººåŠ›è«‹æ±‚æŒ‰éˆ•
        // updateLocationButtonsVisibility();

        showToast('å·²å®šä½åˆ°æ‚¨çš„ä½ç½®', 'success');
      }

      // éš±è—ç”¨æˆ¶ä½ç½®æ¨™è¨˜
      function hideUserLocation() {
        if (userLocationMarker) {
          map.removeLayer(userLocationMarker);
          userLocationMarker = null;
        }

        isLocationVisible = false;

        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        const btn = document.getElementById('locateUserBtn');
        btn.classList.remove('active');
        // ä¿æŒ has-location ç‹€æ…‹ï¼Œå› ç‚ºæˆ‘å€‘ä»ç„¶æœ‰ä½ç½®è³‡è¨Š
        btn.title = 'å®šä½';

        showToast('å·²éš±è—ä½ç½®æ¨™è¨˜', 'info');
      }

      // åˆ‡æ›å®šä½é¡¯ç¤º
      function toggleUserLocation() {
        if (!hasLocationPermission || !userPosition) {
          // æ²’æœ‰æ¬Šé™æˆ–ä½ç½®è³‡è¨Šï¼Œå˜—è©¦ç²å–
          showToast('æ­£åœ¨ç²å–æ‚¨çš„ä½ç½®...', 'info');
          requestUserLocation()
            .then(() => {
              showUserLocation();
            })
            .catch((error) => {
              showToast(error.message, 'error');
            });
        } else {
          // æœ‰æ¬Šé™å’Œä½ç½®è³‡è¨Šï¼Œåˆ‡æ›é¡¯ç¤ºç‹€æ…‹
          if (isLocationVisible) {
            hideUserLocation();
            // å¦‚æœæ­£åœ¨è¿½è¹¤ä½ç½®ï¼Œä¹Ÿåœæ­¢è¿½è¹¤
            if (isWatchingPosition) {
              stopWatchingPosition();
            }
          } else {
            showUserLocation();
          }
        }
      }

      // è™•ç†å®šä½æŒ‰éˆ•çš„é•·æŒ‰äº‹ä»¶ä¾†å•Ÿå‹•ä½ç½®è¿½è¹¤
      async function handleLocationButtonPress() {
        if (!hasLocationPermission || !userPosition) {
          toggleUserLocation();
          return;
        }

        if (isWatchingPosition) {
          // å¦‚æœæ­£åœ¨è¿½è¹¤ï¼Œåœæ­¢è¿½è¹¤
          stopWatchingPosition();
        } else {
          // å¦‚æœæ²’æœ‰è¿½è¹¤ï¼Œå•Ÿå‹•è¿½è¹¤ï¼ˆæ‰‹å‹•è§¸ç™¼æ™‚é¡¯ç¤ºç¢ºèªï¼‰
          if (!isLocationVisible) {
            showUserLocation();
          }
          await startWatchingPosition(true); // æ‰‹å‹•å•Ÿå‹•æ™‚é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        }
      }

      // åˆå§‹åŒ–æ™‚è«‹æ±‚å®šä½æ¬Šé™
      async function initLocationPermission() {
        if (!navigator.geolocation) {
          console.log('ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½');
          showToast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½', 'warning');
          return;
        }

        // æª¢æŸ¥æ¬Šé™ç‹€æ…‹
        if ('permissions' in navigator) {
          try {
            const permission = await navigator.permissions.query({ name: 'geolocation' });
            console.log('åœ°ç†ä½ç½®æ¬Šé™ç‹€æ…‹:', permission.state);

            if (permission.state === 'denied') {
              showToast('åœ°ç†ä½ç½®æ¬Šé™å·²è¢«æ‹’çµ•ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­ç½®ä¸­å…è¨±ä½ç½®è¨ªå•', 'warning');
              return;
            }
          } catch (error) {
            console.log('ç„¡æ³•æª¢æŸ¥æ¬Šé™ç‹€æ…‹:', error);
          }
        }

        // è©¢å•ç”¨æˆ¶æ˜¯å¦å…è¨±å®šä½å’Œå¯¦æ™‚è¿½è¹¤
        const confirmed = await customConfirm(
          'æ­¤ç¶²ç«™æƒ³è¦å–å¾—æ‚¨çš„ä½ç½®è³‡è¨Šä¸¦é–‹å•Ÿå¯¦æ™‚ä½ç½®è¿½è¹¤ï¼Œæ˜¯å¦å…è¨±ï¼Ÿ\r\né€™å°‡å¹«åŠ©æ‚¨åœ¨åœ°åœ–ä¸Šçœ‹åˆ°è‡ªå·±çš„ä½ç½®ä¸¦ä¿æŒæ›´æ–°ã€‚',
          'ä½ç½®æ¬Šé™è«‹æ±‚',
        );

        if (confirmed) {
          showToast('æ­£åœ¨ç²å–ä½ç½®æ¬Šé™...', 'info');
          requestUserLocation()
            .then((position) => {
              showToast('å·²ç²å¾—å®šä½æ¬Šé™ï¼Œæ­£åœ¨å•Ÿå‹•ä½ç½®è¿½è¹¤...', 'success');
              console.log('ç”¨æˆ¶ä½ç½®å·²ç²å–:', position);
              showUserLocation();
              // è‡ªå‹•å•Ÿå‹•ä½ç½®è¿½è¹¤
              setTimeout(() => {
                startWatchingPosition();
              }, 1000); // å»¶é²1ç§’å¾Œå•Ÿå‹•è¿½è¹¤ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ä½ç½®æ¨™è¨˜
            })
            .catch((error) => {
              showToast(error.message, 'error');
              console.log('ç²å–ä½ç½®å¤±æ•—:', error.message);

              // æä¾›é™ç´šæŒ‡å°
              setTimeout(() => {
                const fallbackConfirm = customConfirm(
                  'ç„¡æ³•è‡ªå‹•å®šä½ã€‚æ‚¨ä»å¯ä»¥ï¼š\r\n1. æ‰‹å‹•é»æ“Šåœ°åœ–ä¸Šçš„ä½ç½®\r\n2. æª¢æŸ¥ç€è¦½å™¨åœ°ç†ä½ç½®è¨­ç½®\r\n3. å¦‚æœä½ åœ¨Appä¸­ï¼Œè«‹ç¢ºä¿Appæœ‰é–‹å•Ÿä½ç½®æ¬Šé™ï¼Œæˆ–æ˜¯æ”¹ç‚ºä½¿ç”¨ç€è¦½å™¨é–‹å•Ÿ',
                  'å®šä½å¤±æ•—',
                );

                fallbackConfirm.then((showHelp) => {
                  if (showHelp) {
                    showToast('æ‚¨å¯ä»¥ç›´æ¥åœ¨åœ°åœ–ä¸Šé»æ“Šä¾†æŸ¥çœ‹è¨­æ–½è³‡è¨Š', 'info');
                  }
                });
              }, 2000);
            });
        } else {
          console.log('ç”¨æˆ¶æ‹’çµ•äº†ä½ç½®æ¬Šé™è«‹æ±‚');
          showToast('æ‚¨å¯ä»¥éš¨æ™‚åœ¨åœ°åœ–ä¸Šæ‰‹å‹•æŸ¥çœ‹å„é …è¨­æ–½', 'info');
        }
      }

      // å›å ±å•é¡Œç›¸é—œå‡½æ•¸
      function openReportIssueModal(category, id, name) {
        const modal = document.getElementById('reportIssueModal');
        document.getElementById('issueCategory').value = category;
        document.getElementById('issueName').value = name;
        document.getElementById('issueId').value = id;
        document.getElementById('issueReason').value = '';
        modal.classList.remove('hidden');
      }

      window.openReportIssueModal = openReportIssueModal;

      function closeReportIssueModal() {
        const modal = document.getElementById('reportIssueModal');
        modal.classList.add('hidden');
        document.getElementById('reportIssueForm').reset();
      }

      async function submitIssueReport(event) {
        event.preventDefault();

        const form = document.getElementById('reportIssueForm');
        const formData = new FormData(form);

        const reportData = {
          location_type: formData.get('category'),
          location_id: formData.get('id'),
          name: formData.get('name'),
          reason: formData.get('reason'),
          status: 'false',
        };

        try {
          const response = await fetch(`${API_URL}/reports`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(reportData),
          });

          if (response.ok) {
            showToast('å•é¡Œå›å ±å·²æäº¤ï¼Œæ„Ÿè¬æ‚¨çš„åé¥‹ï¼', 'success');
            closeReportIssueModal();
          } else {
            throw new Error('æäº¤å¤±æ•—');
          }
        } catch (error) {
          console.error('æäº¤å•é¡Œå›å ±å¤±æ•—:', error);
          showToast('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
      }

      // è¿”å›æŒ‰éˆ•åŠŸèƒ½
      function handleGoBack() {
        // æª¢æŸ¥ç€è¦½å™¨æ­·å²è¨˜éŒ„
        if (history.length > 1) {
          // å¦‚æœæœ‰ä¸Šä¸€é ï¼Œè¿”å›ä¸Šä¸€é 
          window.history.back();
        } else {
          // å¦‚æœæ²’æœ‰ä¸Šä¸€é ï¼Œè·³è½‰åˆ°æŒ‡å®šç¶²ç«™
          window.location.href = 'https://sites.google.com/view/guangfu250923';
        }
      }

      // äººåŠ›è«‹æ±‚ç›¸é—œå‡½æ•¸
      let currentUserLocation = null;

      function openHelpRequestModal() {
        const modal = document.getElementById('helpRequestModal');
        modal.classList.remove('hidden');

        // å¦‚æœæœ‰ç”¨æˆ¶ä½ç½®ï¼Œè‡ªå‹•å¡«å…¥åœ°é»
        if (userPosition) {
          const locationInput = document.getElementById('location');
          locationInput.value = `ç·¯åº¦: ${userPosition.lat.toFixed(
            6,
          )}, ç¶“åº¦: ${userPosition.lng.toFixed(6)}`;
          currentUserLocation = userPosition;
        }
      }

      function closeHelpRequestModal() {
        const modal = document.getElementById('helpRequestModal');
        modal.classList.add('hidden');
        document.getElementById('helpRequestForm').reset();
      }

      function submitHelpRequest(event) {
        event.preventDefault();

        const peopleNeeded = parseInt(document.getElementById('peopleNeeded').value, 10);

        if (typeof peopleNeeded !== 'number' || isNaN(peopleNeeded) || peopleNeeded < 1) {
          showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„äººæ•¸ï¼ˆè‡³å°‘1äººï¼‰', 'error');
          return;
        }

        const formData = {
          peopleNeeded,
          type: document.getElementById('requestType').value,
          urgency: document.getElementById('urgencyLevel').value,
          contactPerson: document.getElementById('contactPerson').value,
          contactPhone: document.getElementById('contactPhone').value,
          location: document.getElementById('location').value,
          description: document.getElementById('description').value,
          coordinates: currentUserLocation,
          timestamp: new Date().toISOString(),
        };

        // æ¨¡æ“¬æäº¤è«‹æ±‚ï¼ˆå¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯APIï¼‰
        console.log('æäº¤äººåŠ›è«‹æ±‚:', formData);

        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
        showToast('äººåŠ›è«‹æ±‚å·²æäº¤ï¼Œç›¸é—œå–®ä½å°‡ç›¡å¿«èˆ‡æ‚¨è¯ç¹«', 'success');

        // é—œé–‰æ¨¡æ…‹æ¡†
        closeHelpRequestModal();

        // å¯¦éš›å¯¦ç¾ä¸­ï¼Œé€™è£¡æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯API
        // submitToAPI(formData);
      }

      // æ›´æ–°å®šä½æŒ‰éˆ•çš„é¡¯ç¤ºé‚è¼¯ï¼Œç•¶ç”¨æˆ¶å…è¨±å®šä½æ™‚é¡¯ç¤ºäººåŠ›è«‹æ±‚æŒ‰éˆ•
      function updateLocationButtonsVisibility() {
        const helpRequestBtn = document.getElementById('requestHelpBtn');
        if (hasLocationPermission && userPosition) {
          helpRequestBtn.classList.remove('hidden');
        } else {
          helpRequestBtn.classList.add('hidden');
        }
      }

      // åœ°åœ–åœ–å±¤æ§åˆ¶
      function toggleLayer(layerType) {
        const buttons = document.querySelectorAll('.map-control-btn');
        buttons.forEach((btn) => btn.classList.remove('active'));

        // æ¸…é™¤æ‰€æœ‰åœ–å±¤çš„å‡½æ•¸
        function clearAllLayers() {
          accommodationMarkers.forEach((marker) => map.removeLayer(marker));
          waterStationMarkers.forEach((marker) => map.removeLayer(marker));
          restroomMarkers.forEach((marker) => map.removeLayer(marker));
          showerStationMarkers.forEach((marker) => map.removeLayer(marker));
          medicalStationMarkers.forEach((marker) => map.removeLayer(marker));
          shuttlePolylines.forEach((p) => map.removeLayer(p));
          if (disasterPolygon) map.removeLayer(disasterPolygon);
        }

        switch (layerType) {
          case 'all':
            document.getElementById('showAllBtn').classList.add('active');
            accommodationMarkers.forEach((marker) => map.addLayer(marker));
            waterStationMarkers.forEach((marker) => map.addLayer(marker));
            restroomMarkers.forEach((marker) => map.addLayer(marker));
            showerStationMarkers.forEach((marker) => map.addLayer(marker));
            medicalStationMarkers.forEach((marker) => map.addLayer(marker));
            shuttlePolylines.forEach((p) => map.addLayer(p));
            if (disasterPolygon) map.addLayer(disasterPolygon);
            break;
          case 'accommodation':
            gtag('event', 'click_layer_button', {
                layer_type: 'accommodation',
                button_id: 'showAccommodationBtn'
            });
            clearAllLayers();
            document.getElementById('showAccommodationBtn').classList.add('active');
            accommodationMarkers.forEach((marker) => map.addLayer(marker));
            break;
          case 'shuttle':
            gtag('event', 'click_layer_button', {
                layer_type: 'shuttle',
                button_id: 'showShuttleBtn'
            });
            clearAllLayers();
            document.getElementById('showShuttleBtn').classList.add('active');
            shuttlePolylines.forEach((p) => map.addLayer(p));
            break;
          case 'waterStation':
            gtag('event', 'click_layer_button', {
                lzayer_type: 'waterStation',
                button_id: 'showWaterStationBtn'
            });
            clearAllLayers();
            document.getElementById('showWaterStationBtn').classList.add('active');
            waterStationMarkers.forEach((marker) => map.addLayer(marker));
            break;
          case 'restroom':
            gtag('event', 'click_layer_button', {
                layer_type: 'restroom',
                button_id: 'showRestroomBtn'
            });
            clearAllLayers();
            document.getElementById('showRestroomBtn').classList.add('active');
            restroomMarkers.forEach((marker) => map.addLayer(marker));
            break;
          case 'showerStation':
            gtag('event', 'click_layer_button', {
                layer_type: 'showerStation',
                button_id: 'showShowerStationBtn'
            });
            clearAllLayers();
            document.getElementById('showShowerStationBtn').classList.add('active');
            showerStationMarkers.forEach((marker) => map.addLayer(marker));
            break;
          case 'medicalStation':
            gtag('event', 'click_layer_button', {
                layer_type: 'medicalStation',
                button_id: 'showMedicalStationBtn'
            });
            clearAllLayers();
            document.getElementById('showMedicalStationBtn').classList.add('active');
            medicalStationMarkers.forEach((marker) => map.addLayer(marker));
            break;
          case 'disaster':
            gtag('event', 'click_layer_button', {
              layer_type: 'disaster',
              button_id: 'showDisasterAreaBtn'
            });
            clearAllLayers();
            document.getElementById('showDisasterAreaBtn').classList.add('active');
            if (disasterPolygon) map.addLayer(disasterPolygon);
            break;
        }

        // æ›´æ–°å´é‚Šæ¬„åˆ—è¡¨é¡¯ç¤º
        updateListDisplay(layerType);
      }

      // äº‹ä»¶ç›£è½å™¨
      document.addEventListener('DOMContentLoaded', function () {
        initMap();

        // è¼‰å…¥åœ°åœ–è³‡æ–™
        setTimeout(() => {
          loadMapData();
        }, 1000);

        // æª¢æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡å’Œæ¬Šé™
        console.log('å®‰å…¨ä¸Šä¸‹æ–‡æª¢æŸ¥:');
        console.log('- isSecureContext:', window.isSecureContext);
        console.log('- location.protocol:', window.location.protocol);
        console.log('- navigator.geolocation å¯ç”¨:', !!navigator.geolocation);

        // åˆå§‹åŒ–å®šä½æ¬Šé™
        setTimeout(() => {
          initLocationPermission();
        }, 1500);

        // è¿”å›æŒ‰éˆ•äº‹ä»¶
        document.getElementById('goBackBtn').addEventListener('click', handleGoBack);

        // æ§åˆ¶æŒ‰éˆ•äº‹ä»¶
        document.getElementById('showAllBtn').addEventListener('click', () => toggleLayer('all'));
        document
          .getElementById('showAccommodationBtn')
          .addEventListener('click', () => toggleLayer('accommodation'));
        document
          .getElementById('showShuttleBtn')
          .addEventListener('click', () => toggleLayer('shuttle'));
        document
          .getElementById('showWaterStationBtn')
          .addEventListener('click', () => toggleLayer('waterStation'));
        document
          .getElementById('showRestroomBtn')
          .addEventListener('click', () => toggleLayer('restroom'));
        document
          .getElementById('showShowerStationBtn')
          .addEventListener('click', () => toggleLayer('showerStation'));
        document
          .getElementById('showMedicalStationBtn')
          .addEventListener('click', () => toggleLayer('medicalStation'));
        document
          .getElementById('showDisasterAreaBtn')
          .addEventListener('click', () => toggleLayer('disaster'));

        // å®šä½æŒ‰éˆ•äº‹ä»¶ï¼ˆæ”¯æŒé•·æŒ‰å•Ÿå‹•ä½ç½®è¿½è¹¤ï¼‰
        const locateBtn = document.getElementById('locateUserBtn');
        let pressTimer = null;
        let isLongPress = false;

        locateBtn.addEventListener('mousedown', () => {
          isLongPress = false;
          pressTimer = setTimeout(() => {
            isLongPress = true;
            handleLocationButtonPress(); // é•·æŒ‰è§¸ç™¼ä½ç½®è¿½è¹¤
          }, 800); // 800ms å¾Œè§¸ç™¼é•·æŒ‰
        });

        locateBtn.addEventListener('mouseup', () => {
          clearTimeout(pressTimer);
          if (!isLongPress) {
            toggleUserLocation(); // çŸ­æŒ‰è§¸ç™¼æ­£å¸¸å®šä½
          }
        });

        locateBtn.addEventListener('mouseleave', () => {
          clearTimeout(pressTimer);
        });

        // è§¸æ§è¨­å‚™æ”¯æŒ
        locateBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          isLongPress = false;
          pressTimer = setTimeout(() => {
            isLongPress = true;
            handleLocationButtonPress();
          }, 800);
        });

        locateBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          clearTimeout(pressTimer);
          if (!isLongPress) {
            toggleUserLocation();
          }
        });

        locateBtn.addEventListener('touchcancel', () => {
          clearTimeout(pressTimer);
        });

        document.getElementById('toggleInfoBtn').addEventListener('click', toggleInfoSidebar);

        // äººåŠ›è«‹æ±‚ç›¸é—œäº‹ä»¶ç›£è½å™¨
        document.getElementById('requestHelpBtn').addEventListener('click', openHelpRequestModal);
        document
          .getElementById('closeHelpRequestBtn')
          .addEventListener('click', closeHelpRequestModal);
        document
          .getElementById('cancelHelpRequestBtn')
          .addEventListener('click', closeHelpRequestModal);
        document.getElementById('helpRequestForm').addEventListener('submit', submitHelpRequest);

        // å›å ±å•é¡Œç›¸é—œäº‹ä»¶ç›£è½å™¨
        document
          .getElementById('closeReportIssueBtn')
          .addEventListener('click', closeReportIssueModal);
        document
          .getElementById('cancelReportIssueBtn')
          .addEventListener('click', closeReportIssueModal);
        document.getElementById('reportIssueForm').addEventListener('submit', submitIssueReport);

        // é»æ“Šåœ°åœ–æ™‚é—œé–‰å´é‚Šæ¬„ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
        map.on('click', function () {
          if (window.innerWidth <= 768) {
            closeInfoSidebar();
          }
        });
      });

      // åˆ‡æ›è³‡è¨Šå´é‚Šæ¬„
      function toggleInfoSidebar() {
        const sidebar = document.getElementById('infoSidebar');

        if (sidebar.classList.contains('show')) {
          closeInfoSidebar();
        } else {
          openInfoSidebar();
        }
      }

      // æ‰“é–‹è³‡è¨Šå´é‚Šæ¬„
      function openInfoSidebar() {
        const sidebar = document.getElementById('infoSidebar');
        const btn = document.getElementById('toggleInfoBtn');

        sidebar.classList.add('show');

        btn.textContent = 'é—œé–‰';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
      }

      // é—œé–‰è³‡è¨Šå´é‚Šæ¬„
      function closeInfoSidebar() {
        const sidebar = document.getElementById('infoSidebar');
        const btn = document.getElementById('toggleInfoBtn');

        sidebar.classList.remove('show');

        btn.textContent = 'è³‡è¨Š';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
      }

      // é é¢å¸è¼‰æ™‚æ¸…ç†ä½ç½®è¿½è¹¤
      window.addEventListener('beforeunload', () => {
        if (isWatchingPosition) {
          stopWatchingPosition();
        }
      });
    </script>
  </body>
</html>
