<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>庇護所清單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', 'Noto Sans TC', sans-serif;
        background-color: #f0f4f8;
      }
      .hero-bg {
        background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)),
          url('https://www.nippon.com/cn/ncommon/contents/in-depth/193109/193109.jpg');
        background-size: cover;
        background-position: center;
      }
      .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.6);
        transition: opacity 0.3s ease-in-out;
      }
      .modal-content {
        transition: transform 0.3s ease-in-out;
      }
      .btn {
        @apply font-bold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-300 shadow-md text-lg;
      }
      .btn-primary {
        @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
      }
      .btn-secondary {
        @apply bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500;
      }
      .btn-disabled {
        @apply bg-gray-400 text-white cursor-not-allowed;
      }
      .info-card {
        @apply bg-white rounded-xl shadow-lg border border-gray-200 transition-all duration-300 hover:shadow-xl hover:border-blue-300 overflow-hidden;
      }
      .accordion-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s cubic-bezier(0, 1, 0, 1), padding 0.3s ease-in-out;
      }
      .accordion-body.open {
        max-height: 1000px;
        transition: max-height 1s ease-in-out;
      }
    </style>
  </head>
  <body class="antialiased text-gray-800">
    <section
      class="hero-bg h-[40vh] flex items-center justify-center text-white text-center shadow-lg"
    >
      <div class="bg-black/30 p-8 rounded-lg">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">庇護所清單</h1>
        <p class="text-lg md:text-xl max-w-2xl">提供各地區庇護所與安置點即時需求資訊。</p>
      </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
      <div id="itemsContainer" class="space-y-4">
        <div class="text-center p-8 bg-white rounded-lg shadow-md">
          <p class="text-gray-500">正在載入庇護所資訊...</p>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div id="itemModal" class="fixed inset-0 z-50 items-center justify-center hidden">
      <div class="modal-backdrop fixed inset-0"></div>
    </div>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300"
    >
      <p id="toastMessage"></p>
    </div>

    <script type="module">
      // Global data storage
      let sheltersData = [];

      // --- Utility Functions ---
      function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('opacity-0', 'translate-y-10');
        setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
      }

      // --- Data Loading ---
      async function loadSheltersData() {
        // Alternative CORS proxy
        const apiUrl = 'https://guangfu250923.pttapp.cc/shelters?limit=50&offset=0';

        try {
          const response = await fetch(apiUrl, {
            headers: {
              Accept: 'application/json, text/plain, */*',
              'Accept-Language': 'zh-TW,zh;q=0.9,en;q=0.8',
              'User-Agent':
                'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
              // 'origin': 'https://guangfu250923.pttapp.cc',
              // 'x-requested-with': 'XMLHttpRequest',
            },
            mode: 'cors',
            credentials: 'omit',
          });

          if (!response.ok) {
            throw new Error(`API 請求失敗: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.member || !Array.isArray(data.member)) {
            throw new Error('API 回應格式錯誤');
          }

          sheltersData = data.member
            .map((shelter) => ({
              id: shelter.id,
              name: shelter.name || '',
              contact: shelter.contact_person || shelter.phone || '',
              source: shelter.link || '',
              location: shelter.location || '',
              phone: shelter.phone || '',
              status: shelter.status || '',
              capacity: shelter.capacity,
              current_occupancy: shelter.current_occupancy,
              available_spaces: shelter.available_spaces,
              facilities: shelter.facilities ? shelter.facilities.join(', ') : '',
              notes: shelter.notes || '',
              coordinates: shelter.coordinates,
              opening_hours: shelter.opening_hours || '',
              timestamp: new Date(shelter.updated_at * 1000).toISOString(),
            }))
            .filter((item) => item.name.trim() !== '');

          renderCards();
          showToast(`成功載入 ${sheltersData.length} 筆資料`);
        } catch (error) {
          console.error('載入失敗:', error);
          showToast(`載入失敗：${error.message}`);
          itemsContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-red-500">載入失敗：${error.message}</p></div>`;
        }
      }

      // --- Rendering ---
      function renderCards() {
        itemsContainer.innerHTML = '';

        if (sheltersData.length === 0) {
          itemsContainer.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><p class="text-gray-500">目前尚無庇護所資訊。</p></div>`;
          return;
        }

        sheltersData.forEach((data) => {
          const card = document.createElement('div');
          card.className = `info-card`;
          card.dataset.id = data.id;

          const encodedAddress = encodeURIComponent(data.location || data.name);
          const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;

          // Build capacity info
          const capacityInfo = [];
          if (data.capacity !== null && data.capacity !== undefined) {
            capacityInfo.push(`容量: ${data.capacity}`);
          }
          if (data.current_occupancy !== null && data.current_occupancy !== undefined) {
            capacityInfo.push(`目前人數: ${data.current_occupancy}`);
          }
          if (data.available_spaces !== null && data.available_spaces !== undefined) {
            capacityInfo.push(`可用空間: ${data.available_spaces}`);
          }

          card.innerHTML = `
                    <div class="accordion-header p-4 cursor-pointer flex justify-between items-center">
                        <div class="flex-grow min-w-0">
                             <h3 class="font-bold text-gray-800 text-lg truncate">${
                               data.name || '未命名地點'
                             }</h3>
                             <p class="text-sm text-gray-500 truncate">${
                               data.location || '地址未提供'
                             }</p>
                             ${
                               data.status
                                 ? `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mt-1">${data.status}</span>`
                                 : ''
                             }
                        </div>
                        <div class="flex items-center gap-1 flex-shrink-0 ml-4">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 transition-transform accordion-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                               <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                             </svg>
                        </div>
                    </div>
                    <div class="accordion-body border-t border-gray-200">
                        <div class="p-4 space-y-4 text-gray-700">
                             <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                                ${
                                  data.phone
                                    ? `<p><span class="font-semibold text-gray-500">電話:</span> ${data.phone}</p>`
                                    : ''
                                }
                                ${
                                  data.contact
                                    ? `<p><span class="font-semibold text-gray-500">聯絡人:</span> ${data.contact}</p>`
                                    : ''
                                }
                                <div class="md:col-span-2 flex items-center justify-between">
                                    <p><span class="font-semibold text-gray-500">地點:</span> ${
                                      data.location || '未提供'
                                    }</p>
                                    ${
                                      data.location
                                        ? `
                                    <a href="${mapLink}" target="_blank" rel="noopener noreferrer" class="ml-4 flex-shrink-0 bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full hover:bg-blue-600 transition-colors">
                                        前往地圖
                                    </a>
                                    `
                                        : ''
                                    }
                                </div>
                                ${
                                  capacityInfo.length > 0
                                    ? `<p><span class="font-semibold text-gray-500">容量資訊:</span> ${capacityInfo.join(
                                        ' | ',
                                      )}</p>`
                                    : ''
                                }
                                ${
                                  data.facilities
                                    ? `<p><span class="font-semibold text-gray-500">設施:</span> ${data.facilities}</p>`
                                    : ''
                                }
                                ${
                                  data.opening_hours
                                    ? `<p><span class="font-semibold text-gray-500">開放時間:</span> ${data.opening_hours}</p>`
                                    : ''
                                }
                            </div>
                            ${
                              data.notes
                                ? `
                            <div class="text-sm bg-gray-50 p-3 rounded-md">
                                <p class="font-semibold mb-1">備註:</p>
                                <p class="whitespace-pre-wrap">${data.notes}</p>
                            </div>
                            `
                                : ''
                            }
                            ${
                              data.source
                                ? `<p class="text-xs text-gray-400"><span class="font-semibold">資料來源:</span> <a href="${data.source}" target="_blank" class="text-blue-500 hover:underline">${data.source}</a></p>`
                                : ''
                            }
                        </div>
                    </div>
                `;
          itemsContainer.appendChild(card);
        });
      }

      // --- Modal Functions ---
      function openModal() {
        itemModal.classList.remove('hidden');
        itemModal.classList.add('flex');
        document.getElementById('modalTitle').textContent = '新增庇護所資訊';
        itemForm.reset();
        document.getElementById('rowIndex').value = '';
      }

      function closeModal() {
        itemModal.classList.add('hidden');
        itemModal.classList.remove('flex');
      }

      itemModal.addEventListener('click', (e) => {
        if (e.target === itemModal) closeModal();
      });

      itemsContainer.addEventListener('click', (e) => {
        const header = e.target.closest('.accordion-header');
        if (header && !e.target.closest('button')) {
          const body = header.nextElementSibling;
          const arrow = header.querySelector('.accordion-arrow');
          if (body.classList.contains('open')) {
            body.classList.remove('open');
            arrow.classList.remove('rotate-180');
          } else {
            document.querySelectorAll('.accordion-body.open').forEach((openBody) => {
              openBody.classList.remove('open');
              openBody.previousElementSibling
                .querySelector('.accordion-arrow')
                .classList.remove('rotate-180');
            });
            body.classList.add('open');
            arrow.classList.add('rotate-180');
          }
        }
      });

      loadSheltersData();
    </script>
  </body>
</html>
